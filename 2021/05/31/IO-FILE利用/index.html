<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="Ev3r"><meta name="copyright" content="Ev3r"><meta name="generator" content="Hexo 5.4.0"><meta name="theme" content="hexo-theme-yun"><title>IO_FILEåˆ©ç”¨ | Ev3r's blog</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.24/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_ed8vp4atwoj.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>document.addEventListener("DOMContentLoaded", () => {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
});
</script><link id="light-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism.css" media="(prefers-color-scheme: light)"><link id="dark-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism-tomorrow.css" media="(prefers-color-scheme: dark)"><link rel="shortcut icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="alternate icon" href="/yun.ico"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"example.com","root":"/","title":"Ev3r","version":"1.5.2","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"æƒ³è¦æœä»€ä¹ˆï¼Œæ¥è¿™é‡Œ","empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹: ${query}","hits":"æ‰¾åˆ° ${hits} æ¡ç»“æœ","hits_time":"æ‰¾åˆ° ${hits} æ¡ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰"},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://el-bot-api.vercel.app/api/words/young"},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/utils.js"></script><script src="/js/hexo-theme-yun.js"></script><link rel="preconnect" href="https://www.google-analytics.com" crossorigin><script async src="https://www.googletagmanager.com/gtag/js?id=UA-121354150-1"></script><script>if (CONFIG.hostname === location.hostname) {
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-121354150-1');
}</script><script data-ad-client="ca-pub-2245427233262012" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(function(){
  var bp = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https') {
    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else {
    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})();</script><!-- Google Tag Manager --><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-M9KWR9L');</script><!-- End Google Tag Manager --><meta name="description" content="è§£æFILEæ˜¯IOåº“ä¸­ç”¨äºæè¿°æ–‡ä»¶çš„ç»“æ„ï¼Œè¢«ç§°ä¸ºæ–‡ä»¶æµã€‚FILEåœ¨æ‰§è¡Œfopenç­‰å‡½æ•°çš„æ—¶å€™ä¼šåˆ›å»ºï¼Œ  ç»“æ„ä½“ &#x2F;* We always allocate an extra word following an _IO_FILE.    This contains a pointer to the function jump table used.    This is for compatibil">
<meta property="og:type" content="article">
<meta property="og:title" content="IO_FILEåˆ©ç”¨">
<meta property="og:url" content="http://example.com/2021/05/31/IO-FILE%E5%88%A9%E7%94%A8/index.html">
<meta property="og:site_name" content="Ev3r&#39;s blog">
<meta property="og:description" content="è§£æFILEæ˜¯IOåº“ä¸­ç”¨äºæè¿°æ–‡ä»¶çš„ç»“æ„ï¼Œè¢«ç§°ä¸ºæ–‡ä»¶æµã€‚FILEåœ¨æ‰§è¡Œfopenç­‰å‡½æ•°çš„æ—¶å€™ä¼šåˆ›å»ºï¼Œ  ç»“æ„ä½“ &#x2F;* We always allocate an extra word following an _IO_FILE.    This contains a pointer to the function jump table used.    This is for compatibil">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-05-31T12:53:04.000Z">
<meta property="article:modified_time" content="2021-06-06T13:32:14.740Z">
<meta property="article:author" content="Ev3r">
<meta property="article:tag" content="IO_FILE">
<meta name="twitter:card" content="summary"><script src="/js/ui/mode.js"></script></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="æ–‡ç« ç›®å½•"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="ç«™ç‚¹æ¦‚è§ˆ"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info mickey-mouse"><a class="site-author-avatar" href="/about/" title="Ev3r"><img width="96" loading="lazy" src="/images/head.jpg" alt="Ev3r"><span class="site-author-status" title="nothing for pwn">ğŸ™‚</span></a><div class="site-author-name"><a href="/about/">Ev3r</a></div><span class="site-name">Ev3r's blog</span><sub class="site-subtitle"></sub><div class="site-desciption"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="æˆ‘çš„ä¸»é¡µ"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="å½’æ¡£"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">71</span></a></div><div class="site-state-item"><a href="/categories/" title="åˆ†ç±»"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">7</span></a></div><div class="site-state-item"><a href="/tags/" title="æ ‡ç­¾"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">36</span></a></div><a class="site-state-item hty-icon-button" href="/about/#comment" title="ç•™è¨€æ¿"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-clipboard-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="/atom.xml" title="RSS" target="_blank" style="color:orange"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-rss-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/myenid?tab=repositories" title="GitHub" target="_blank" style="color:#181717"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://ctf-wiki.org/pwn/readme/" title="Wiki" target="_blank" style="color:#0084FF"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-zhihu-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/504533786" title="å“”å“©å“”å“©åŠ¨ç”»" target="_blank" style="color:#FF8EB3"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-bilibili-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" target="_blank" rel="noopener" href="https://mlysoft.cn/cross.html" title="jså¸ˆå‚…" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">è§£æ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#fread%E5%87%BD%E6%95%B0"><span class="toc-number">1.1.</span> <span class="toc-text">freadå‡½æ•°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">æºç åˆ†æ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fwrite"><span class="toc-number">1.3.</span> <span class="toc-text">fwrite</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fopen"><span class="toc-number">1.4.</span> <span class="toc-text">fopen</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fclose"><span class="toc-number">1.5.</span> <span class="toc-text">fclose</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#printf-puts"><span class="toc-number">1.6.</span> <span class="toc-text">printf&#x2F;puts</span></a></li></ol></li></ol></div></div></div><div class="tag-cloud"><div class="tag-cloud-tags"><a href="/tags/BJDCTF-2nd%E5%A4%8D%E7%8E%B0/" style="font-size: 21px; color: #4d89c0">BJDCTF 2ndå¤ç°</a> <a href="/tags/IO-FILE/" style="font-size: 12px; color: #999">IO_FILE</a> <a href="/tags/Linux/" style="font-size: 21px; color: #4d89c0">Linux</a> <a href="/tags/Nep2021/" style="font-size: 12px; color: #999">Nep2021</a> <a href="/tags/SROP/" style="font-size: 25.5px; color: #2680d4">SROP</a> <a href="/tags/UAF/" style="font-size: 30px; color: #0078e7">UAF</a> <a href="/tags/VNCTF2021/" style="font-size: 12px; color: #999">VNCTF2021</a> <a href="/tags/ciscn2021/" style="font-size: 12px; color: #999">ciscn2021</a> <a href="/tags/debug/" style="font-size: 12px; color: #999">debug</a> <a href="/tags/double-free/" style="font-size: 16.5px; color: #7391ad">double_free</a> <a href="/tags/fastbin/" style="font-size: 12px; color: #999">fastbin</a> <a href="/tags/fastbin-attack/" style="font-size: 12px; color: #999">fastbin-attack</a> <a href="/tags/libc%E6%B3%84%E9%9C%B2/" style="font-size: 16.5px; color: #7391ad">libcæ³„éœ²</a> <a href="/tags/off-by-one%E5%8E%9F%E7%90%86%E5%92%8C%E5%88%A9%E7%94%A8/" style="font-size: 12px; color: #999">off_by_oneåŸç†å’Œåˆ©ç”¨</a> <a href="/tags/orw%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/" style="font-size: 12px; color: #999">orwç³»ç»Ÿè°ƒç”¨</a> <a href="/tags/overflow/" style="font-size: 12px; color: #999">overflow</a> <a href="/tags/overlap/" style="font-size: 12px; color: #999">overlap</a> <a href="/tags/overlapping/" style="font-size: 12px; color: #999">overlapping</a> <a href="/tags/reverse/" style="font-size: 12px; color: #999">reverse</a> <a href="/tags/shell/" style="font-size: 12px; color: #999">shell</a></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://example.com/2021/05/31/IO-FILE%E5%88%A9%E7%94%A8/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="Ev3r"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="Ev3r's blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">IO_FILEåˆ©ç”¨<a class="post-edit-link" href="https://github.com/myenid/myenid.github.io_posts/IO-FILEåˆ©ç”¨.md" target="_blank" title="ç¼–è¾‘" rel="noopener"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-edit-line"></use></svg></a></h1><div class="post-meta"><div class="post-time" style="display:inline-block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="åˆ›å»ºæ—¶é—´ï¼š2021-05-31 20:53:04" itemprop="dateCreated datePublished" datetime="2021-05-31T20:53:04+08:00">2021-05-31</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-06-06 21:32:14" itemprop="dateModified" datetime="2021-06-06T21:32:14+08:00">2021-06-06</time></div><span class="leancloud_visitors" id="/2021/05/31/IO-FILE%E5%88%A9%E7%94%A8/" data-flag-title="IO_FILEåˆ©ç”¨"><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="é˜…è¯»æ¬¡æ•°"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-eye-line"></use></svg> <span class="leancloud-visitors-count"></span></span></span><span class="post-meta-divider">-</span><a href="#comment"><span class="post-meta-item-icon" title="è¯„è®ºæ•°"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-chat-3-line"></use></svg> <span class="waline-comment-count" id="/2021/05/31/IO-FILE%E5%88%A9%E7%94%A8/"></span></span></a><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category" href="/categories/pwn%E6%80%BB%E7%BB%93/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">pwnæ€»ç»“</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag" href="/tags/IO-FILE/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">IO_FILE</span></a></span></div><div class="post-author"><span class="author-name">Ev3r</span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#0078E7;"><h1 id="è§£æ"><a href="#è§£æ" class="headerlink" title="è§£æ"></a>è§£æ</h1><p>FILEæ˜¯IOåº“ä¸­ç”¨äºæè¿°æ–‡ä»¶çš„ç»“æ„ï¼Œè¢«ç§°ä¸ºæ–‡ä»¶æµã€‚FILEåœ¨æ‰§è¡Œfopenç­‰å‡½æ•°çš„æ—¶å€™ä¼šåˆ›å»ºï¼Œ </p>
<p>ç»“æ„ä½“</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* We always allocate an extra word following an _IO_FILE.
   This contains a pointer to the function jump table used.
   This is for compatibility with C++ streambuf; the word can
   be used to smash to a pointer to a virtual function table. */</span>

<span class="token keyword">struct</span> <span class="token class-name">_IO_FILE_plus</span>
<span class="token punctuation">&#123;</span>
  _IO_FILE file<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">_IO_jump_t</span> <span class="token operator">*</span>vtable<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¸­æœ‰_IO_FILEç»“æ„ä½“å’Œå¸¸é‡_IO_jump_tï¼ˆå†…å®¹ä¸å¯è¢«ä¿®æ”¹ï¼‰å…³äºvtableæœ‰è™šè¡¨ä¸€è¯´ï¼Œé‡Œé¢å­˜çš„æ˜¯å„ç§æ“ä½œå‡½æ•°çš„æŒ‡é’ˆã€‚</p>
<p>è€ŒFILEç»“æ„ä½“å­˜çš„åˆ™æ˜¯ä¸€äº›ï¼Œæ•°æ®æŒ‡é’ˆã€‚åœ¨ libc2.23 ç‰ˆæœ¬ä¸‹ï¼Œ32 ä½çš„ vtable åç§»ä¸º 0x94ï¼Œ64 ä½åç§»ä¸º 0xd8</p>
<p>IO_FILEå¦‚ä¸‹</p>
<p>æºç </p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">_IO_FILE</span> <span class="token punctuation">&#123;</span>
<span class="token keyword">int</span> _flags<span class="token punctuation">;</span>       <span class="token comment">/* High-order word is _IO_MAGIC; rest is flags. */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_IO_file_flags</span> <span class="token expression">_flags</span></span>
 
  <span class="token comment">/* The following pointers correspond to the C++ streambuf protocol. */</span>
  <span class="token comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span>
  <span class="token keyword">char</span><span class="token operator">*</span> _IO_read_ptr<span class="token punctuation">;</span>   <span class="token comment">/* Current read pointer */</span>
  <span class="token keyword">char</span><span class="token operator">*</span> _IO_read_end<span class="token punctuation">;</span>   <span class="token comment">/* End of get area. */</span>
  <span class="token keyword">char</span><span class="token operator">*</span> _IO_read_base<span class="token punctuation">;</span>  <span class="token comment">/* Start of putback+get area. */</span>
  <span class="token keyword">char</span><span class="token operator">*</span> _IO_write_base<span class="token punctuation">;</span> <span class="token comment">/* Start of put area. */</span>
  <span class="token keyword">char</span><span class="token operator">*</span> _IO_write_ptr<span class="token punctuation">;</span>  <span class="token comment">/* Current put pointer. */</span>
  <span class="token keyword">char</span><span class="token operator">*</span> _IO_write_end<span class="token punctuation">;</span>  <span class="token comment">/* End of put area. */</span>
  <span class="token keyword">char</span><span class="token operator">*</span> _IO_buf_base<span class="token punctuation">;</span>   <span class="token comment">/* Start of reserve area. */</span>
  <span class="token keyword">char</span><span class="token operator">*</span> _IO_buf_end<span class="token punctuation">;</span>    <span class="token comment">/* End of reserve area. */</span>
  <span class="token comment">/* The following fields are used to support backing up and undo. */</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_save_base<span class="token punctuation">;</span> <span class="token comment">/* Pointer to start of non-current get area. */</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_backup_base<span class="token punctuation">;</span>  <span class="token comment">/* Pointer to first valid character of backup area */</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>_IO_save_end<span class="token punctuation">;</span> <span class="token comment">/* Pointer to end of non-current get area. */</span>
 
  <span class="token keyword">struct</span> <span class="token class-name">_IO_marker</span> <span class="token operator">*</span>_markers<span class="token punctuation">;</span>
 
  <span class="token keyword">struct</span> <span class="token class-name">_IO_FILE</span> <span class="token operator">*</span>_chain<span class="token punctuation">;</span>
 
  <span class="token keyword">int</span> _fileno<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span>
  <span class="token keyword">int</span> _blksize<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
  <span class="token keyword">int</span> _flags2<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
  _IO_off_t _old_offset<span class="token punctuation">;</span> <span class="token comment">/* This used to be _offset but it's too small.  */</span>
 
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__HAVE_COLUMN</span> <span class="token comment">/* temporary */</span></span>
  <span class="token comment">/* 1+column number of pbase(); 0 is unknown. */</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">short</span> _cur_column<span class="token punctuation">;</span>
  <span class="token keyword">signed</span> <span class="token keyword">char</span> _vtable_offset<span class="token punctuation">;</span>
  <span class="token keyword">char</span> _shortbuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 
<span class="token comment">/*  char* _save_gptr;  char* _save_egptr; */</span>
 
_IO_lock_t <span class="token operator">*</span>_lock<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_IO_USE_OLD_IO_FILE</span></span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å…·ä½“æ˜¯å•¥ï¼Œæ³¨é‡Šå¤§æ¦‚éƒ½å†™äº†ï¼Œæ³¨æ„åˆ°**_chain**è¿™ä¸ªæŒ‡é’ˆï¼Œå®ƒæŒ‡å‘ä¸€ä¸ªé“¾è¡¨ï¼Œè¿™ä¸ªé“¾è¡¨å­˜å‚¨çš„æ˜¯</p>
<blockquote>
<p>stdin stdout stderrè¿™ä¸‰ä¸ªæ–‡ä»¶æè¿°ç¬¦çš„æŒ‡é’ˆå½¢æˆçš„é“¾è¡¨</p>
</blockquote>
<p>åœ¨ç³»ç»Ÿè°ƒç”¨åˆ°freadè¿™ç±»çš„å‡½æ•°å°±ä¼šè‡ªåŠ¨åˆå§‹åŒ–è¿™ä¸‰ä¸ªæè¿°ç¬¦ï¼Œå­˜å‚¨åœ¨bssæ®µã€‚è€Œè¦æ³¨æ„çš„æ˜¯ä½¿ç”¨ fopen åˆ›å»ºçš„æ–‡ä»¶æµæ˜¯åˆ†é…åœ¨å †å†…å­˜ä¸Šçš„ã€‚</p>
<p>å…ˆçœ‹ä¸€ä¸‹IO_jump_tçš„å†…å®¹</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">_IO_jump_t</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">,</span> __dummy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">,</span> __dummy2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_finish_t<span class="token punctuation">,</span> __finish<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_overflow_t<span class="token punctuation">,</span> __overflow<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_underflow_t<span class="token punctuation">,</span> __underflow<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_underflow_t<span class="token punctuation">,</span> __uflow<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_pbackfail_t<span class="token punctuation">,</span> __pbackfail<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* showmany */</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_xsputn_t<span class="token punctuation">,</span> __xsputn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_xsgetn_t<span class="token punctuation">,</span> __xsgetn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_seekoff_t<span class="token punctuation">,</span> __seekoff<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_seekpos_t<span class="token punctuation">,</span> __seekpos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_setbuf_t<span class="token punctuation">,</span> __setbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_sync_t<span class="token punctuation">,</span> __sync<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_doallocate_t<span class="token punctuation">,</span> __doallocate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_read_t<span class="token punctuation">,</span> __read<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_write_t<span class="token punctuation">,</span> __write<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_seek_t<span class="token punctuation">,</span> __seek<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_close_t<span class="token punctuation">,</span> __close<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_stat_t<span class="token punctuation">,</span> __stat<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_showmanyc_t<span class="token punctuation">,</span> __showmanyc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_imbue_t<span class="token punctuation">,</span> __imbue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span>
    get_column<span class="token punctuation">;</span>
    set_column<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>è€Œå…³äºstdinå’Œoutçš„å®šä¹‰å¦‚ä¸‹</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">extern</span> <span class="token keyword">struct</span> <span class="token class-name">_IO_FILE_plus</span> _IO_2_1_stdin_<span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">struct</span> <span class="token class-name">_IO_FILE_plus</span> _IO_2_1_stdout_<span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">struct</span> <span class="token class-name">_IO_FILE_plus</span> _IO_2_1_stderr_<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h2 id="freadå‡½æ•°"><a href="#freadå‡½æ•°" class="headerlink" title="freadå‡½æ•°"></a>freadå‡½æ•°</h2><p>fread æ˜¯æ ‡å‡† IO åº“å‡½æ•°ï¼Œä½œç”¨æ˜¯ä»æ–‡ä»¶æµä¸­è¯»æ•°æ®ï¼Œå‡½æ•°åŸå‹å¦‚ä¸‹</p>
<p>çœ‹ä¸€ä¸‹åŸå‹</p>
<pre class="line-numbers language-none"><code class="language-none">size_t fread ( void *buffer, size_t size, size_t count, FILE *stream) ;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>buffer å­˜æ”¾è¯»å–æ•°æ®çš„ç¼“å†²åŒºã€‚</li>
<li>sizeï¼šæŒ‡å®šæ¯ä¸ªè®°å½•çš„é•¿åº¦ã€‚</li>
<li>countï¼š æŒ‡å®šè®°å½•çš„ä¸ªæ•°ã€‚</li>
<li>streamï¼šç›®æ ‡æ–‡ä»¶æµã€‚</li>
<li>è¿”å›å€¼ï¼šè¿”å›è¯»å–åˆ°æ•°æ®ç¼“å†²åŒºä¸­çš„è®°å½•ä¸ªæ•°</li>
</ul>
<p>æºç </p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"libioP.h"</span></span>

_IO_size_t
<span class="token function">_IO_fread</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> _IO_size_t size<span class="token punctuation">,</span> _IO_size_t count<span class="token punctuation">,</span> _IO_FILE <span class="token operator">*</span>fp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  _IO_size_t bytes_requested <span class="token operator">=</span> size <span class="token operator">*</span> count<span class="token punctuation">;</span> <span class="token comment">// all bytes</span>
  _IO_size_t bytes_read<span class="token punctuation">;</span>
  <span class="token function">CHECK_FILE</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>bytes_requested <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">_IO_acquire_lock</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  bytes_read <span class="token operator">=</span> <span class="token function">_IO_sgetn</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> buf<span class="token punctuation">,</span> bytes_requested<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">_IO_release_lock</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> bytes_requested <span class="token operator">==</span> bytes_read <span class="token operator">?</span> count <span class="token operator">:</span> bytes_read <span class="token operator">/</span> size<span class="token punctuation">;</span>
  <span class="token comment">//return the sount that have recvied</span>
<span class="token punctuation">&#125;</span>
<span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>_IO_fread<span class="token punctuation">)</span>

<span class="token function">weak_alias</span> <span class="token punctuation">(</span>_IO_fread<span class="token punctuation">,</span> fread<span class="token punctuation">)</span>

<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">ifndef</span> <span class="token expression">_IO_MTSAFE_IO</span></span>
<span class="token function">strong_alias</span> <span class="token punctuation">(</span>_IO_fread<span class="token punctuation">,</span> __fread_unlocked<span class="token punctuation">)</span>
<span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>__fread_unlocked<span class="token punctuation">)</span>
<span class="token function">weak_alias</span> <span class="token punctuation">(</span>_IO_fread<span class="token punctuation">,</span> fread_unlocked<span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¯¥å‡½æ•°çœŸæ­£çš„å®ç°æ˜¯åœ¨_IO_sgetnå‡½æ•°ã€‚libio.hé‡Œé¢ã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">extern</span> _IO_size_t <span class="token function">_IO_sgetn</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">,</span> _IO_size_t<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ç„¶åæŸ¥äº†ä¸€ä¸‹è§£é‡Šï¼Œå‘ç°æœ‰ç‚¹å¥—å¨ƒã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">_IO_size_t
<span class="token function">_IO_sgetn</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span>fp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> _IO_size_t n<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">/* FIXME handle putback buffer here! */</span>
  <span class="token keyword">return</span> <span class="token function">_IO_XSGETN</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> data<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>_IO_sgetn<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å†…éƒ¨è°ƒç”¨äº†<code>_IO_XSGETN</code>ç„¶åå†æŸ¥çœ‹è¿™ä¸ª</p>
<p><code>#define _IO_XSGETN(FP, DATA, N) JUMP2 (__xsgetn, FP, DATA, N)</code></p>
<p><code>JUMP2</code>å‡½æ•°ã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">JUMP2</span><span class="token expression"><span class="token punctuation">(</span>FUNC<span class="token punctuation">,</span> THIS<span class="token punctuation">,</span> X1<span class="token punctuation">,</span> X2<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">_IO_JUMPS_FUNC</span><span class="token punctuation">(</span>THIS<span class="token punctuation">)</span><span class="token operator">-></span>FUNC<span class="token punctuation">)</span> <span class="token punctuation">(</span>THIS<span class="token punctuation">,</span> X1<span class="token punctuation">,</span> X2<span class="token punctuation">)</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>åœ¨é»˜è®¤æƒ…å†µä¸‹å‡½æ•°æŒ‡é’ˆæ˜¯æŒ‡å‘_IO_file_xsgetn å‡½æ•°çš„ï¼Œ</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">_IO_size_t
<span class="token function">_IO_file_xsgetn</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span>fp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> _IO_size_t n<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  _IO_size_t want<span class="token punctuation">,</span> have<span class="token punctuation">;</span>
  _IO_ssize_t count<span class="token punctuation">;</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>s <span class="token operator">=</span> data<span class="token punctuation">;</span>

  want <span class="token operator">=</span> n<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_buf_base <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token comment">/* Maybe we already have a push back pointer.  */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_save_base <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#123;</span>
	  <span class="token function">free</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_save_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
	  fp<span class="token operator">-></span>_flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>_IO_IN_BACKUP<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
      <span class="token function">_IO_doallocbuf</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>want <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      have <span class="token operator">=</span> fp<span class="token operator">-></span>_IO_read_end <span class="token operator">-</span> fp<span class="token operator">-></span>_IO_read_ptr<span class="token punctuation">;</span><span class="token comment">//read buffer</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>want <span class="token operator">&lt;=</span> have<span class="token punctuation">)</span><span class="token comment">//data is enough</span>
	<span class="token punctuation">&#123;</span>
	  <span class="token function">memcpy</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> fp<span class="token operator">-></span>_IO_read_ptr<span class="token punctuation">,</span> want<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//copy want bytes to s(data)</span>
	  fp<span class="token operator">-></span>_IO_read_ptr <span class="token operator">+=</span> want<span class="token punctuation">;</span><span class="token comment">//change the ptr of read begin</span>
	  want <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
      <span class="token keyword">else</span><span class="token comment">//not enough</span>
	<span class="token punctuation">&#123;</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span>have <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
	    <span class="token punctuation">&#123;</span>
	      s <span class="token operator">=</span> <span class="token function">__mempcpy</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> fp<span class="token operator">-></span>_IO_read_ptr<span class="token punctuation">,</span> have<span class="token punctuation">)</span><span class="token punctuation">;</span>
	      want <span class="token operator">-=</span> have<span class="token punctuation">;</span>
	      fp<span class="token operator">-></span>_IO_read_ptr <span class="token operator">+=</span> have<span class="token punctuation">;</span>
	    <span class="token punctuation">&#125;</span>

	  <span class="token comment">/* Check for backup and repeat */</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IO_in_backup</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">)</span>
	    <span class="token punctuation">&#123;</span>
	      <span class="token function">_IO_switch_to_main_get_area</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
	      <span class="token keyword">continue</span><span class="token punctuation">;</span>
	    <span class="token punctuation">&#125;</span>

	  <span class="token comment">/* If we now want less than a buffer, underflow and repeat
	     the copy.  Otherwise, _IO_SYSREAD directly to
	     the user buffer. */</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_buf_base
	      <span class="token operator">&amp;&amp;</span> want <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_buf_end <span class="token operator">-</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">)</span><span class="token punctuation">)</span>
	    <span class="token punctuation">&#123;</span>
	      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__underflow</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>

	      <span class="token keyword">continue</span><span class="token punctuation">;</span>
	    <span class="token punctuation">&#125;</span>

	  <span class="token comment">/* These must be set before the sysread as we might longjmp out
	     waiting for input. */</span>
	  <span class="token function">_IO_setg</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">,</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">,</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token function">_IO_setp</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">,</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">)</span><span class="token punctuation">;</span>

	  <span class="token comment">/* Try to maintain alignment: read a whole number of blocks.  */</span>
	  count <span class="token operator">=</span> want<span class="token punctuation">;</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">)</span>
	    <span class="token punctuation">&#123;</span>
	      _IO_size_t block_size <span class="token operator">=</span> fp<span class="token operator">-></span>_IO_buf_end <span class="token operator">-</span> fp<span class="token operator">-></span>_IO_buf_base<span class="token punctuation">;</span>
	      <span class="token keyword">if</span> <span class="token punctuation">(</span>block_size <span class="token operator">>=</span> <span class="token number">128</span><span class="token punctuation">)</span>
		count <span class="token operator">-=</span> want <span class="token operator">%</span> block_size<span class="token punctuation">;</span>
	    <span class="token punctuation">&#125;</span>

	  count <span class="token operator">=</span> <span class="token function">_IO_SYSREAD</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> s<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
	    <span class="token punctuation">&#123;</span>
	      <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		fp<span class="token operator">-></span>_flags <span class="token operator">|=</span> _IO_EOF_SEEN<span class="token punctuation">;</span>
	      <span class="token keyword">else</span>
		fp<span class="token operator">-></span>_flags <span class="token operator">|=</span> _IO_ERR_SEEN<span class="token punctuation">;</span>

	      <span class="token keyword">break</span><span class="token punctuation">;</span>
	    <span class="token punctuation">&#125;</span>

	  s <span class="token operator">+=</span> count<span class="token punctuation">;</span>
	  want <span class="token operator">-=</span> count<span class="token punctuation">;</span>
	  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_offset <span class="token operator">!=</span> _IO_pos_BAD<span class="token punctuation">)</span>
	    <span class="token function">_IO_pos_adjust</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_offset<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

  <span class="token keyword">return</span> n <span class="token operator">-</span> want<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ•´ä½“æµç¨‹ä¸º<code>fread</code>è°ƒç”¨<code>_IO_sgetn</code>ï¼Œ<code>_IO_sgetn</code>è°ƒç”¨vtableä¸­çš„<code>_IO_XSGETN</code>ä¹Ÿå°±æ˜¯<code>_IO_file_xsgetn</code>ï¼Œ<code>_IO_file_xsgetn</code>æ˜¯<code>fread</code>å®ç°çš„æ ¸å¿ƒå‡½æ•°ã€‚</p>
<p>è€Œæ ¸å¿ƒå‡½æ•°çš„å®ç°å¤§æ¦‚æ˜¯é¦–å…ˆç¬¬ä¸€æ®µ</p>
<ul>
<li>ç¬¬ä¸€éƒ¨åˆ†æ˜¯<code>fp-&gt;_IO_buf_base</code>ä¸ºç©ºçš„æƒ…å†µï¼Œè¡¨æ˜æ­¤æ—¶çš„FILEç»“æ„ä½“ä¸­çš„æŒ‡é’ˆæœªè¢«åˆå§‹åŒ–ï¼Œè¾“å…¥ç¼“å†²åŒºæœªå»ºç«‹ï¼Œåˆ™è°ƒç”¨<code>_IO_doallocbuf</code>å»åˆå§‹åŒ–æŒ‡é’ˆï¼Œå»ºç«‹è¾“å…¥ç¼“å†²åŒºã€‚</li>
<li>ç¬¬äºŒéƒ¨åˆ†æ˜¯è¾“å…¥ç¼“å†²åŒºé‡Œæœ‰è¾“å…¥ï¼Œå³<code>fp-&gt;_IO_read_ptr</code>å°äº<code>fp-&gt;_IO_read_end</code>ï¼Œæ­¤æ—¶å°†ç¼“å†²åŒºé‡Œçš„æ•°æ®ç›´æ¥æ‹·è´è‡³ç›®æ ‡buffã€‚</li>
<li>ç¬¬ä¸‰éƒ¨åˆ†æ˜¯è¾“å…¥ç¼“å†²åŒºé‡Œçš„æ•°æ®ä¸ºç©ºæˆ–è€…æ˜¯ä¸èƒ½æ»¡è¶³å…¨éƒ¨çš„éœ€æ±‚ï¼Œåˆ™è°ƒç”¨<code>__underflow</code>è°ƒç”¨ç³»ç»Ÿè°ƒç”¨è¯»å…¥æ•°æ®ã€‚</li>
</ul>
<h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><h2 id="fwrite"><a href="#fwrite" class="headerlink" title="fwrite"></a>fwrite</h2><p>fwrite åŒæ ·æ˜¯æ ‡å‡† IO åº“å‡½æ•°ï¼Œä½œç”¨æ˜¯å‘æ–‡ä»¶æµå†™å…¥æ•°æ®ï¼Œå‡½æ•°åŸå‹å¦‚ä¸‹</p>
<pre class="line-numbers language-none"><code class="language-none">size_t fwrite(const void* buffer, size_t size, size_t count, FILE* stream);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>buffer: æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå¯¹ fwrite æ¥è¯´ï¼Œæ˜¯è¦å†™å…¥æ•°æ®çš„åœ°å€;</li>
<li>size: è¦å†™å…¥å†…å®¹çš„å•å­—èŠ‚æ•°;</li>
<li>count: è¦è¿›è¡Œå†™å…¥ size å­—èŠ‚çš„æ•°æ®é¡¹çš„ä¸ªæ•°;</li>
<li>stream: ç›®æ ‡æ–‡ä»¶æŒ‡é’ˆ;</li>
<li>è¿”å›å€¼ï¼šå®é™…å†™å…¥çš„æ•°æ®é¡¹ä¸ªæ•° countã€‚</li>
</ul>
<p>fwriteçš„æºç åœ¨<code>/libio/iofwrite.c</code>é‡Œé¢ï¼Œ</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"libioP.h"</span></span>

_IO_size_t
<span class="token function">_IO_fwrite</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> _IO_size_t size<span class="token punctuation">,</span> _IO_size_t count<span class="token punctuation">,</span> _IO_FILE <span class="token operator">*</span>fp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  _IO_size_t request <span class="token operator">=</span> size <span class="token operator">*</span> count<span class="token punctuation">;</span>
  _IO_size_t written <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">CHECK_FILE</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>request <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token function">_IO_acquire_lock</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_IO_vtable_offset</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token function">_IO_fwide</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    written <span class="token operator">=</span> <span class="token function">_IO_sputn</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> buf<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">_IO_release_lock</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* We have written all of the input in case the return value indicates
     this or EOF is returned.  The latter is a special case where we
     simply did not manage to flush the buffer.  But the data is in the
     buffer and therefore written as far as fwrite is concerned.  */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>written <span class="token operator">==</span> request <span class="token operator">||</span> written <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    <span class="token keyword">return</span> written <span class="token operator">/</span> size<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>_IO_fwrite<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åˆ†æä¸€ä¸‹è¿™ä¸ªå‡½æ•°ï¼Œé¦–å…ˆåˆ¤æ–­<code>if (_IO_vtable_offset (fp) != 0 || _IO_fwide (fp, -1) == -1)</code></p>
<p>å…³äºè¿™ä¸¤ä¸ªå‡½æ•°çš„å®šä¹‰ï¼Œåˆæ­¥æ–­å®šå¦‚ä¸‹ã€‚</p>
<p>å…³äº<code>_IO_fwide</code>æœ‰</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"> <span class="token comment">/* Normalize the value.  */</span>
  mode <span class="token operator">=</span> mode <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">:</span> <span class="token punctuation">(</span>mode <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">SHLIB_COMPAT</span> <span class="token punctuation">(</span>libc<span class="token punctuation">,</span> GLIBC_2_0<span class="token punctuation">,</span> GLIBC_2_1<span class="token punctuation">)</span></span></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__builtin_expect</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>_IO_stdin_used <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>fp <span class="token operator">==</span> _IO_stdin <span class="token operator">||</span> fp <span class="token operator">==</span> _IO_stdout <span class="token operator">||</span> fp <span class="token operator">==</span> _IO_stderr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">/* This is for a stream in the glibc 2.0 format.  */</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æˆªå–ä¸€å°éƒ¨åˆ†ï¼Œæ„Ÿè§‰æ˜¯åˆ¤æ–­fpæ˜¯ä¸æ˜¯æŒ‡å‘stdé‚£ä¸‰ä¸ªä½ç½®ï¼Œå¦‚æœæ˜¯ï¼Œè¿”å›-1.é‚£ä¹ˆè¿›å…¥ifçš„å…³é”®å°±æ˜¯å‰é¢é‚£ä¸ªäº†ã€‚çœ‹åå­—åº”è¯¥æ˜¯è·å¾—fpç»“æ„ä½“çš„è™šè¡¨åç§»</p>
<pre class="line-numbers language-ABAP" data-language="ABAP"><code class="language-ABAP">#if _IO_JUMPS_OFFSET
# define _IO_JUMPS_FUNC(THIS) \
  (IO_validate_vtable                                                   \
   (*(struct _IO_jump_t **) ((void *) &amp;_IO_JUMPS_FILE_plus (THIS)	\
			     + (THIS)-&gt;_vtable_offset)))
# define _IO_vtable_offset(THIS) (THIS)-&gt;_vtable_offset
#else
# define _IO_JUMPS_FUNC(THIS) (IO_validate_vtable (_IO_JUMPS_FILE_plus (THIS)))
# define _IO_vtable_offset(THIS) 0
#endif<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>é‡ç‚¹åœ¨è¿ä¸ªå‡½æ•°çš„å®šä¹‰ï¼Œè¦è¿”å›0çš„è¯</p>
<ul>
<li>_IO_JUMPS_OFFSETæ²¡æœ‰</li>
<li>å¦åˆ™è¿”å›å½“å‰æµæŒ‡é’ˆçš„è™šè¡¨åç§»</li>
</ul>
<p>é‚£ä¹ˆæ„æ€æ˜¯å°±æ˜¯fpæŒ‡é’ˆè¦æŒ‡å‘é‚£ä¸‰ä¸ªæŒ‡é’ˆï¼ˆæˆ–è€…è¯´fpæ˜¯ä¸€ä¸ªIO_FILEç»“æ„ä½“ï¼‰ç„¶åè¿›å…¥äº†å…³é”®å‡½æ•°ï¼Œ</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">written <span class="token operator">=</span> <span class="token function">_IO_sputn</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> buf<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æ ¹æ®å‰é¢å¯¹_IO_FILE_plus çš„ä»‹ç»ï¼Œå¯çŸ¥_IO_XSPUTN ä½äº_IO_FILE_plus çš„ vtable ä¸­ï¼Œè°ƒç”¨è¿™ä¸ªå‡½æ•°éœ€è¦é¦–å…ˆå–å‡º vtable ä¸­çš„æŒ‡é’ˆï¼Œå†è·³è¿‡å»è¿›è¡Œè°ƒç”¨ã€‚</p>
<pre class="line-numbers language-apl" data-language="apl"><code class="language-apl"><span class="token constant">#</span>define _IO_sputn<span class="token punctuation">(</span>__fp<span class="token function">,</span> __s<span class="token function">,</span> __n<span class="token punctuation">)</span> _IO_XSPUTN <span class="token punctuation">(</span>__fp<span class="token function">,</span> __s<span class="token function">,</span> __n<span class="token punctuation">)</span>

<span class="token constant">#</span>define _IO_XSPUTN<span class="token punctuation">(</span>FP<span class="token function">,</span> DATA<span class="token function">,</span> N<span class="token punctuation">)</span> JUMP2 <span class="token punctuation">(</span>__xsputn<span class="token function">,</span> FP<span class="token function">,</span> DATA<span class="token function">,</span> N<span class="token punctuation">)</span>

<span class="token constant">#</span>define JUMP2<span class="token punctuation">(</span>FUNC<span class="token function">,</span> THIS<span class="token function">,</span> X1<span class="token function">,</span> X2<span class="token punctuation">)</span> <span class="token punctuation">(</span>_IO_JUMPS_FUNC<span class="token punctuation">(</span>THIS<span class="token punctuation">)</span><span class="token function">-</span><span class="token function">></span>FUNC<span class="token punctuation">)</span> <span class="token punctuation">(</span>THIS<span class="token function">,</span> X1<span class="token function">,</span> X2<span class="token punctuation">)</span>

<span class="token constant">#</span>if _IO_JUMPS_OFFSET
<span class="token comment"># define _IO_JUMPS_FUNC(THIS) \</span>
  <span class="token punctuation">(</span>IO_validate_vtable                                                   <span class="token monadic-operator operator">\</span>
   <span class="token punctuation">(</span><span class="token function">*</span><span class="token punctuation">(</span>struct _IO_jump_t <span class="token function">*</span><span class="token function">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>void <span class="token function">*</span><span class="token punctuation">)</span> <span class="token monadic-operator operator">&amp;</span>_IO_JUMPS_FILE_plus <span class="token punctuation">(</span>THIS<span class="token punctuation">)</span>	<span class="token monadic-operator operator">\</span>
			     <span class="token function">+</span> <span class="token punctuation">(</span>THIS<span class="token punctuation">)</span><span class="token function">-</span><span class="token function">></span>_vtable_offset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># define _IO_vtable_offset(THIS) (THIS)->_vtable_offset</span>
<span class="token constant">#</span>else
<span class="token comment"># define _IO_JUMPS_FUNC(THIS) (IO_validate_vtable (_IO_JUMPS_FILE_plus (THIS)))</span>
<span class="token comment"># define _IO_vtable_offset(THIS) 0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨_IO_XSPUTN å¯¹åº”çš„é»˜è®¤å‡½æ•°_IO_new_file_xsputn ä¸­ä¼šè°ƒç”¨åŒæ ·ä½äº vtable ä¸­çš„_IO_OVERFLOW</p>
<pre class="line-numbers language-apl" data-language="apl"><code class="language-apl"><span class="token monadic-operator operator">/</span><span class="token function">*</span> Next flush the <span class="token punctuation">(</span>full<span class="token punctuation">)</span> buffer<span class="token dyadic-operator operator">.</span> <span class="token function">*</span><span class="token monadic-operator operator">/</span>
     if <span class="token punctuation">(</span>_IO_OVERFLOW <span class="token punctuation">(</span>f<span class="token function">,</span> EOF<span class="token punctuation">)</span> <span class="token function">=</span><span class="token function">=</span> EOF<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>_IO_OVERFLOW é»˜è®¤å¯¹åº”çš„å‡½æ•°æ˜¯_IO_new_file_overflow</p>
<pre class="line-numbers language-apl" data-language="apl"><code class="language-apl">if <span class="token punctuation">(</span>ch <span class="token function">=</span><span class="token function">=</span> EOF<span class="token punctuation">)</span>
    return _IO_do_write <span class="token punctuation">(</span>f<span class="token function">,</span> f<span class="token function">-</span><span class="token function">></span>_IO_write_base<span class="token function">,</span>
             f<span class="token function">-</span><span class="token function">></span>_IO_write_ptr <span class="token function">-</span> f<span class="token function">-</span><span class="token function">></span>_IO_write_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
  if <span class="token punctuation">(</span>f<span class="token function">-</span><span class="token function">></span>_IO_write_ptr <span class="token function">=</span><span class="token function">=</span> f<span class="token function">-</span><span class="token function">></span>_IO_buf_end <span class="token punctuation">)</span> <span class="token monadic-operator operator">/</span><span class="token function">*</span> Buffer is really full <span class="token function">*</span><span class="token monadic-operator operator">/</span>
    if <span class="token punctuation">(</span>_IO_do_flush <span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token function">=</span><span class="token function">=</span> EOF<span class="token punctuation">)</span>
      return EOF<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨_IO_new_file_overflow å†…éƒ¨æœ€ç»ˆä¼šè°ƒç”¨ç³»ç»Ÿæ¥å£ write å‡½æ•°</p>
<h2 id="fopen"><a href="#fopen" class="headerlink" title="fopen"></a>fopen</h2><p>fopen åœ¨æ ‡å‡† IO åº“ä¸­ç”¨äºæ‰“å¼€æ–‡ä»¶ï¼Œå‡½æ•°åŸå‹å¦‚ä¸‹</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">FILE <span class="token operator">*</span><span class="token function">fopen</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span> <span class="token operator">*</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>filename: ç›®æ ‡æ–‡ä»¶çš„è·¯å¾„</li>
<li>type: æ‰“å¼€æ–¹å¼çš„ç±»å‹</li>
<li>è¿”å›å€¼: è¿”å›ä¸€ä¸ªæ–‡ä»¶æŒ‡é’ˆ</li>
</ul>
<p>åœ¨ fopen å†…éƒ¨ä¼šåˆ›å»º FILE ç»“æ„å¹¶è¿›è¡Œä¸€äº›åˆå§‹åŒ–æ“ä½œï¼Œä¸‹é¢æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹<code>iofopoen</code>å‡½æ•°ã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">__fopen_internal</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>mode<span class="token punctuation">,</span> <span class="token keyword">int</span> is32<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>æ•´ä¸ª<code>__fopen_internal</code>å‡½æ•°åŒ…å«å››ä¸ªéƒ¨åˆ†ï¼š</p>
<ol>
<li><code>malloc</code>åˆ†é…å†…å­˜ç©ºé—´ã€‚</li>
<li><code>_IO_no_init</code> å¯¹fileç»“æ„ä½“è¿›è¡Œ<code>null</code>åˆå§‹åŒ–ã€‚</li>
<li><code>_IO_file_init</code>å°†ç»“æ„ä½“é“¾æ¥è¿›<code>_IO_list_all</code>é“¾è¡¨ã€‚</li>
<li><code>_IO_file_fopen</code>æ‰§è¡Œç³»ç»Ÿè°ƒç”¨æ‰“å¼€æ–‡ä»¶ã€‚</li>
</ol>
<p>ä¸‹é¢è¯¦ç»†åˆ†æè·Ÿè¿›å»æ¯ä¸ªå­å‡½æ•°è¿›è¡Œåˆ†æã€‚</p>
<p>åœ¨å‡½æ•°å†…éƒ¨ï¼Œé¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªç»“æ„ä½“</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">locked_FILE</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">struct</span> <span class="token class-name">_IO_FILE_plus</span> fp<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_IO_MTSAFE_IO</span></span>
    _IO_lock_t lock<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token keyword">struct</span> <span class="token class-name">_IO_wide_data</span> wd<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token operator">*</span>new_f <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">locked_FILE</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">malloc</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">locked_FILE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿™ä¸ªç»“æ„ä½“ï¼Œåœ¨64ä½ç³»ç»Ÿä¸­ä¸º0x230</p>
<p>ç”³è¯·ä¸€å—å†…å­˜ç»™new_fã€‚ç„¶åè°ƒç”¨åˆå§‹åŒ–çš„å‡½æ•°ï¼Œ</p>
<pre class="line-numbers language-fsharp" data-language="fsharp"><code class="language-fsharp">_IO_no_init <span class="token punctuation">(</span><span class="token operator">&amp;</span>new_f<span class="token operator">-></span>fp<span class="token punctuation">.</span>file<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>new_f<span class="token operator">-></span>wd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_IO_wfile_jumps<span class="token punctuation">)</span><span class="token punctuation">;</span>
  _IO_JUMPS <span class="token punctuation">(</span><span class="token operator">&amp;</span>new_f<span class="token operator">-></span>fp<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>_IO_file_jumps<span class="token punctuation">;</span>
  _IO_new_file_init_internal <span class="token punctuation">(</span><span class="token operator">&amp;</span>new_f<span class="token operator">-></span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>åœ¨_IO_file_init å‡½æ•°çš„åˆå§‹åŒ–æ“ä½œä¸­ï¼Œä¼šè°ƒç”¨_IO_link_in æŠŠæ–°åˆ†é…çš„ FILE é“¾å…¥_IO_list_all ä¸ºèµ·å§‹çš„ FILE é“¾è¡¨ä¸­</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span>
<span class="token function">_IO_old_init</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span>fp<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  fp<span class="token operator">-></span>_flags <span class="token operator">=</span> _IO_MAGIC<span class="token operator">|</span>flags<span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_flags2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>stdio_needs_locking<span class="token punctuation">)</span>
    fp<span class="token operator">-></span>_flags2 <span class="token operator">|=</span> _IO_FLAGS2_NEED_LOCK<span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_IO_buf_base <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_IO_buf_end <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_IO_read_base <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_IO_read_ptr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_IO_read_end <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_IO_write_base <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_IO_write_ptr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_IO_write_end <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_chain <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">/* Not necessary. */</span>

  fp<span class="token operator">-></span>_IO_save_base <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_IO_backup_base <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_IO_save_end <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_markers <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_cur_column <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">_IO_JUMPS_OFFSET</span></span>
  fp<span class="token operator">-></span>_vtable_offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_IO_MTSAFE_IO</span></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_lock <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token function">_IO_lock_init</span> <span class="token punctuation">(</span><span class="token operator">*</span>fp<span class="token operator">-></span>_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span>
<span class="token function">_IO_no_init</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span>fp<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">int</span> orientation<span class="token punctuation">,</span>
	     <span class="token keyword">struct</span> <span class="token class-name">_IO_wide_data</span> <span class="token operator">*</span>wd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">_IO_jump_t</span> <span class="token operator">*</span>jmp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token function">_IO_old_init</span> <span class="token punctuation">(</span>fp<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_mode <span class="token operator">=</span> orientation<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>orientation <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      fp<span class="token operator">-></span>_wide_data <span class="token operator">=</span> wd<span class="token punctuation">;</span>
      fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_IO_buf_base <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_IO_buf_end <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_IO_read_base <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_IO_read_ptr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_IO_read_end <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_IO_write_base <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_IO_write_ptr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_IO_write_end <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_IO_save_base <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_IO_backup_base <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_IO_save_end <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

      fp<span class="token operator">-></span>_wide_data<span class="token operator">-></span>_wide_vtable <span class="token operator">=</span> jmp<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token keyword">else</span>
    <span class="token comment">/* Cause predictable crash when a wide function is called on a byte
       stream.  */</span>
    fp<span class="token operator">-></span>_wide_data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">_IO_wide_data</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">;</span>
  fp<span class="token operator">-></span>_freeres_list <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åˆå§‹åŒ–æ“ä½œå¦‚ä¸Šï¼Œå‡ ä¹å…¨éƒ¨åˆå§‹åŒ–ä¸ºNULLã€‚åœ¨æ‰§è¡Œå®Œ<code>_IO_no_init</code>å‡½æ•°åï¼Œå›åˆ°<code>__fopen_internal</code>å‡½æ•°ï¼Œå‡½æ•°å°†<code>_IO_FILE_plus</code>ç»“æ„ä½“çš„vtableè®¾ç½®æˆäº†<code>_IO_file_jumps</code>ï¼Œç„¶åè°ƒç”¨<code>_IO_file_init</code>å°†<code>_IO_FILE_plus</code>ç»“æ„ä½“é“¾æ¥è¿›å…¥<code>_IO_list_all</code>é“¾è¡¨ã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span>
<span class="token function">_IO_new_file_init_internal</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">_IO_FILE_plus</span> <span class="token operator">*</span>fp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">/* POSIX.1 allows another file handle to be used to change the position
     of our file descriptor.  Hence we actually don't know the actual
     position before we do the first fseek (and until a following fflush). */</span>
  fp<span class="token operator">-></span>file<span class="token punctuation">.</span>_offset <span class="token operator">=</span> _IO_pos_BAD<span class="token punctuation">;</span>
  fp<span class="token operator">-></span>file<span class="token punctuation">.</span>_IO_file_flags <span class="token operator">|=</span> CLOSED_FILEBUF_FLAGS<span class="token punctuation">;</span>

  <span class="token function">_IO_link_in</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  fp<span class="token operator">-></span>file<span class="token punctuation">.</span>_fileno <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¸»è¦åœ¨<code>_IO_link_in</code>å‡½æ•°çš„ä½œç”¨ï¼Œçœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„æºç </p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span>
<span class="token function">_IO_link_in</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">_IO_FILE_plus</span> <span class="token operator">*</span>fp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fp<span class="token operator">-></span>file<span class="token punctuation">.</span>_flags <span class="token operator">&amp;</span> _IO_LINKED<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      fp<span class="token operator">-></span>file<span class="token punctuation">.</span>_flags <span class="token operator">|=</span> _IO_LINKED<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_IO_MTSAFE_IO</span></span>
      <span class="token function">_IO_cleanup_region_start_noarg</span> <span class="token punctuation">(</span>flush_cleanup<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">_IO_lock_lock</span> <span class="token punctuation">(</span>list_all_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
      run_fp <span class="token operator">=</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span><span class="token punctuation">)</span> fp<span class="token punctuation">;</span>
      <span class="token function">_IO_flockfile</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span><span class="token punctuation">)</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
      fp<span class="token operator">-></span>file<span class="token punctuation">.</span>_chain <span class="token operator">=</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span><span class="token punctuation">)</span> _IO_list_all<span class="token punctuation">;</span>
      _IO_list_all <span class="token operator">=</span> fp<span class="token punctuation">;</span>
	  <span class="token comment">// link this fp to chain</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_IO_MTSAFE_IO</span></span>
      <span class="token function">_IO_funlockfile</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span><span class="token punctuation">)</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
      run_fp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      <span class="token function">_IO_lock_unlock</span> <span class="token punctuation">(</span>list_all_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">_IO_cleanup_region_end</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">libc_hidden_def</span> <span class="token punctuation">(</span>_IO_link_in<span class="token punctuation">)</span>

<span class="token keyword">struct</span> <span class="token class-name">_IO_FILE_plus</span> <span class="token operator">*</span>_IO_list_all <span class="token operator">=</span> <span class="token operator">&amp;</span>_IO_2_1_stderr_<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿™é‡Œ<code>_IO_link_in</code>å‡½æ•°çš„åŠŸèƒ½æ˜¯æ£€æŸ¥FILEç»“æ„ä½“æ˜¯å¦åŒ…å«<code>_IO_LINKED</code>æ ‡å¿—ï¼Œå¦‚æœä¸åŒ…å«åˆ™è¡¨ç¤ºè¿™ä¸ªç»“æ„ä½“æ²¡æœ‰é“¾æ¥è¿›å…¥<code>_IO_list_all</code>ï¼Œåˆ™å†åé¢æŠŠå®ƒé“¾æ¥è¿›å…¥<code>_IO_list_all</code>é“¾è¡¨ï¼ŒåŒæ—¶è®¾ç½®FILEç»“æ„ä½“çš„<code>_chain</code>å­—æ®µä¸ºä¹‹å‰çš„é“¾è¡¨çš„å€¼ï¼Œå¦åˆ™ç›´æ¥è¿”å›ã€‚</p>
<p>æ‰€ä»¥<code>_IO_file_init</code>ä¸»è¦åŠŸèƒ½æ˜¯å°†FILEç»“æ„ä½“é“¾æ¥è¿›å…¥<code>_IO_list_all</code>é“¾è¡¨ï¼Œåœ¨æ²¡æ‰§è¡Œ<code>_IO_file_init</code>å‡½æ•°å‰<code>_IO_list_all</code>æŒ‡å‘çš„æ˜¯<code>stderr</code>ç»“æ„ä½“ï¼Œæ‰§è¡Œå®Œåå¯ä»¥çœ‹åˆ°<code>_IO_list_all</code>æŒ‡å‘çš„æ˜¯ç”³è¯·å‡ºæ¥çš„ç»“æ„ä½“</p>
<p>ç„¶åå›åˆ°fopenå‡½æ•°ï¼Œè·³åˆ°äº†**_IO_file_fopen**å‡½æ•°ï¼Œç„¶åè¿™ä¸ªå‡½æ•°çš„å®šä¹‰æ²¡æ‰¾åˆ°ï¼Œå¤§æ¦‚å°±æ˜¯è°ƒç”¨å‡½æ•°æ‰“å¼€ï¼Œå¦‚æœæ²¡æ‰“å¼€çš„è¯å°±ä¼šè°ƒç”¨åé¢çš„_un_linkå’Œfreeé‡Šæ”¾è¿™ä¸ªç»“æ„ä½“ï¼Œç„¶åæ‰“å¼€å¤±è´¥ã€‚</p>
<h2 id="fclose"><a href="#fclose" class="headerlink" title="fclose"></a>fclose</h2><p>fclose æ˜¯æ ‡å‡† IO åº“ä¸­ç”¨äºå…³é—­å·²æ‰“å¼€æ–‡ä»¶çš„å‡½æ•°ï¼Œå…¶ä½œç”¨ä¸ fopen ç›¸åã€‚</p>
<pre class="line-numbers language-none"><code class="language-none">int fclose(FILE *stream)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>åŠŸèƒ½ï¼šå…³é—­ä¸€ä¸ªæ–‡ä»¶æµï¼Œä½¿ç”¨ fclose å°±å¯ä»¥æŠŠç¼“å†²åŒºå†…æœ€åå‰©ä½™çš„æ•°æ®è¾“å‡ºåˆ°ç£ç›˜æ–‡ä»¶ä¸­ï¼Œå¹¶é‡Šæ”¾æ–‡ä»¶æŒ‡é’ˆå’Œæœ‰å…³çš„ç¼“å†²åŒº</p>
<p>fclose é¦–å…ˆä¼šè°ƒç”¨_IO_unlink_it å°†æŒ‡å®šçš„ FILE ä»_chain é“¾è¡¨ä¸­è„±é“¾</p>
<pre class="line-numbers language-none"><code class="language-none">if (fp-&gt;_IO_file_flags &amp; _IO_IS_FILEBUF)
    _IO_un_link ((struct _IO_FILE_plus *) fp);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>ä¹‹åä¼šè°ƒç”¨_IO_file_close_it å‡½æ•°ï¼Œ_IO_file_close_it ä¼šè°ƒç”¨ç³»ç»Ÿæ¥å£ close å…³é—­æ–‡ä»¶</p>
<pre class="line-numbers language-none"><code class="language-none">if (fp-&gt;_IO_file_flags &amp; _IO_IS_FILEBUF)
    status &#x3D; _IO_file_close_it (fp);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>æœ€åè°ƒç”¨ vtable ä¸­çš„_IO_FINISHï¼Œå…¶å¯¹åº”çš„æ˜¯_IO_file_finish å‡½æ•°ï¼Œå…¶ä¸­ä¼šè°ƒç”¨ free å‡½æ•°é‡Šæ”¾ä¹‹å‰åˆ†é…çš„ FILE ç»“æ„</p>
<pre class="line-numbers language-none"><code class="language-none">_IO_FINISH (fp);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="printf-puts"><a href="#printf-puts" class="headerlink" title="printf/puts"></a>printf/puts</h2><p>printf å’Œ puts æ˜¯å¸¸ç”¨çš„è¾“å‡ºå‡½æ•°ï¼Œåœ¨ printf çš„å‚æ•°æ˜¯ä»¥â€™\nâ€™ç»“æŸçš„çº¯å­—ç¬¦ä¸²æ—¶ï¼Œprintf ä¼šè¢«ä¼˜åŒ–ä¸º puts å‡½æ•°å¹¶å»é™¤æ¢è¡Œç¬¦ã€‚</p>
<p>puts åœ¨æºç ä¸­å®ç°çš„å‡½æ•°æ˜¯_IO_putsï¼Œè¿™ä¸ªå‡½æ•°çš„æ“ä½œä¸ fwrite çš„æµç¨‹å¤§è‡´ç›¸åŒï¼Œå‡½æ•°å†…éƒ¨åŒæ ·ä¼šè°ƒç”¨ vtable ä¸­çš„_IO_sputnï¼Œç»“æœä¼šæ‰§è¡Œ_IO_new_file_xsputnï¼Œæœ€åä¼šè°ƒç”¨åˆ°ç³»ç»Ÿæ¥å£ write å‡½æ•°ã€‚</p>
<p>printf çš„è°ƒç”¨æ ˆå›æº¯å¦‚ä¸‹ï¼ŒåŒæ ·æ˜¯é€šè¿‡_IO_file_xsputn å®ç°</p>
<pre class="line-numbers language-none"><code class="language-none">vfprintf+11
_IO_file_xsputn
_IO_file_overflow
funlockfile
_IO_file_write
write<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

</div><ul class="post-copyright"><li class="post-copyright-author"><strong>æœ¬æ–‡ä½œè€…ï¼š</strong>Ev3r</li><li class="post-copyright-link"><strong>æœ¬æ–‡é“¾æ¥ï¼š</strong><a href="http://example.com/2021/05/31/IO-FILE%E5%88%A9%E7%94%A8/" title="IO_FILEåˆ©ç”¨">http://example.com/2021/05/31/IO-FILE%E5%88%A9%E7%94%A8/</a></li><li class="post-copyright-license"><strong>ç‰ˆæƒå£°æ˜ï¼š</strong>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é»˜è®¤é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-Ev3r/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-EV3R 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-Ev3r-line"></use></svg></a> è®¸å¯åè®®ã€‚</li></ul></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2021/06/04/qiandao/" rel="prev" title="qiandao"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">qiandao</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2021/05/24/%E7%AE%97%E6%B3%95%E9%A2%98%E8%AE%B0%E5%BD%95/" rel="next" title="ç®—æ³•é¢˜è®°å½•"><span class="post-nav-text">ç®—æ³•é¢˜è®°å½•</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>å¦‚æœæ‚¨æœ‰ä»»ä½•å…³äºåšå®¢å†…å®¹çš„ç›¸å…³è®¨è®ºï¼Œæ¬¢è¿å‰å¾€ <a href="https://github.com/YunYouJun/yunyoujun.github.io/discussions" target="_blank">GitHub Discussions</a> ä¸æˆ‘äº¤æµã€‚</span><br></div><div id="waline"></div><script>Yun.utils.getScript("https://cdn.jsdelivr.net/npm/@waline/client/dist/Waline.min.js", () => {
  const walineConfig = {"enable":true,"serverURL":"https://waline.yunyoujun.cn","comment":true,"visitor":true,"avatarCDN":"https://cdn.v2ex.com/gravatar/","placeholder":"å¡«å†™é‚®ç®±ï¼Œå¯ä»¥æ”¶åˆ°å›å¤é€šçŸ¥å“¦ï½","requiredFields":["nick"],"el":"#waline","lang":"zh-CN"}
  walineConfig.path = "/2021/05/31/IO-FILE%E5%88%A9%E7%94%A8/"
  new Waline(walineConfig)
}, window.Waline);</script></div></main><footer class="sidebar-translate" id="footer"><div class="beian"><a rel="noopener" href="https://beian.miit.gov.cn/" target="_blank">è¿™é‡Œæ˜¯</a></div><div class="copyright"><span>&copy; 2021 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> Ev3r</span></div><div class="powered"><span>ç”± <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> é©±åŠ¨ v5.4.0</span><span class="footer-separator">|</span><span>ä¸»é¢˜ - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.5.2</span></div><div class="live_time"><span>æœ¬åšå®¢å·²è¯ç”Ÿ</span><span id="display_live_time"></span><span class="moe-text">(â—'â—¡'â—)</span><script>function blog_live_time() {
  setTimeout(blog_live_time, 1000);
  const start = new Date('2021-03-10T00:00:00');
  const now = new Date();
  const timeDiff = (now.getTime() - start.getTime());
  const msPerMinute = 60 * 1000;
  const msPerHour = 60 * msPerMinute;
  const msPerDay = 24 * msPerHour;
  const passDay = Math.floor(timeDiff / msPerDay);
  const passHour = Math.floor((timeDiff % msPerDay) / 60 / 60 / 1000);
  const passMinute = Math.floor((timeDiff % msPerHour) / 60 / 1000);
  const passSecond = Math.floor((timeDiff % msPerMinute) / 1000);
  display_live_time.innerHTML = " " + passDay + " å¤© " + passHour + " å°æ—¶ " + passMinute + " åˆ† " + passSecond + " ç§’";
}
blog_live_time();
</script></div><div class="footer-custom-text">pwnèœé¸¡</a></div></footer><a class="hty-icon-button" id="goUp" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><script>const date = new Date();
const today = (date.getMonth() + 1) + "-" + date.getDate()
const mourn_days = ["4-4"]
if (mourn_days.includes(today)) {
  document.documentElement.style.filter = "grayscale(1)";
}</script></div></body></html>